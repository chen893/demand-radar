# Demand Radar v2.1 - 技术设计文档 (TDD)

> 版本: 2.1
> 更新日期: 2025-12-10
> 文档类型: 设计意图与架构决策
> 配套文档: PRD-2.1

---

## 一、设计意图概览

### 1.1 本次迭代的核心问题

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         问题 → 设计意图 → 解决方案                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  问题 1: 页面切换导致分析丢失                                             │
│  ───────────────────────────────                                        │
│  根因: 状态与页面强绑定                                                   │
│  意图: 解耦「当前页面」与「分析任务」                                      │
│  方案: 引入 AnalysisTask 独立生命周期                                     │
│                                                                         │
│  问题 2: 逐个分析效率低                                                   │
│  ───────────────────────────                                            │
│  根因: 单任务模型，无队列                                                 │
│  意图: 支持批量处理，后台执行                                             │
│  方案: 复用任务队列，并发控制                                             │
│                                                                         │
│  问题 3: 数据来源单一                                                     │
│  ───────────────────────                                                │
│  根因: 仅支持 Reddit/知乎                                                 │
│  意图: 扩展平台覆盖，捕获更多信号                                         │
│  方案: 新增 Twitter 适配器                                               │
│                                                                         │
│  问题 4: 无法发现重复模式                                                 │
│  ─────────────────────────                                              │
│  根因: 需求孤立存储，无关联                                               │
│  意图: 识别反复出现的方向                                                 │
│  方案: LLM 去重分析 + 用户确认分组                                        │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 1.2 设计原则

| 原则 | 含义 | 本迭代体现 |
|-----|------|-----------|
| **关注点分离** | 不同职责的数据/逻辑应隔离 | currentPage 与 tasks 解耦 |
| **渐进增强** | 新功能不破坏现有流程 | 向后兼容，无感升级 |
| **用户可控** | 自动化需用户确认 | 去重结果需确认后合并 |
| **优雅降级** | 异常情况有回退方案 | Twitter 多重选择器 |
| **本地优先** | 数据默认在本地 | 任务状态在内存，结果持久化 |

---

## 二、架构决策记录 (ADR)

### ADR-001: 分析任务独立化

#### 背景

v2.0 的状态设计：
```
pageInfo 变化 → 重置 status/demands/... → 分析结果丢失
```

#### 决策

**将「当前页面」与「分析任务」解耦为两个独立状态域**

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              状态域分离                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   ┌───────────────────────┐        ┌───────────────────────────────┐   │
│   │    当前页面状态域      │        │        任务状态域              │   │
│   │   (View-bound)        │        │     (Independent)             │   │
│   ├───────────────────────┤        ├───────────────────────────────┤   │
│   │ currentPage           │        │ tasks: AnalysisTask[]         │   │
│   │   - url               │        │   - id                        │   │
│   │   - title             │        │   - source (快照)              │   │
│   │   - platform          │        │   - status                    │   │
│   │   - canAnalyze        │        │   - result                    │   │
│   └───────────────────────┘        │ activeTaskId                  │   │
│            │                       └───────────────────────────────┘   │
│            │                                    │                      │
│            ▼                                    ▼                      │
│   ┌───────────────────────┐        ┌───────────────────────────────┐   │
│   │  URL 变化时更新        │        │  独立生命周期                  │   │
│   │  不影响任务           │        │  页面切换不受影响              │   │
│   └───────────────────────┘        └───────────────────────────────┘   │
│                                                                         │
│   连接点: activeTaskId 实现「当前页面」与「关联任务」的动态绑定          │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 备选方案对比

| 方案 | 优点 | 缺点 | 结论 |
|-----|------|------|------|
| A: 状态域分离 | 清晰、可扩展 | 需重构现有代码 | ✅ 采用 |
| B: 持久化到 IndexedDB | 刷新后可恢复 | 复杂度高，需同步 | ❌ 过度设计 |
| C: 缓存最近 N 个结果 | 改动小 | 无法支持批量、多任务 | ❌ 不够彻底 |

#### 影响

- 需重构 `analysis.ts` store
- 新增 `AnalysisTask` 类型
- Side Panel UI 需适配

---

### ADR-002: 任务存储策略

#### 背景

AnalysisTask 应存储在哪里？

#### 决策

**内存存储（Zustand），不持久化到 IndexedDB**

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           存储策略对比                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   数据类型          存储位置           生命周期          持久化          │
│   ──────────────────────────────────────────────────────────────────── │
│   AnalysisTask      Zustand (内存)    浏览器会话        ✗              │
│   Extraction        IndexedDB         永久             ✓              │
│   Demand            IndexedDB         永久             ✓              │
│   DemandGroup       IndexedDB         永久             ✓              │
│                                                                         │
│   为什么 Task 不持久化？                                                 │
│   ─────────────────────                                                 │
│   1. Task 是「过程态」，完成后结果存入 Extraction/Demand                │
│   2. 持久化增加复杂度（需处理恢复、状态同步）                            │
│   3. 用户关闭浏览器 = 放弃未完成任务，符合预期                           │
│   4. 重要数据（分析结果）已持久化，Task 只是临时状态                     │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 数据流向

```
               创建任务                     分析完成
用户点击 ──────────────▶ AnalysisTask ──────────────▶ Extraction + Demand
「分析」                  (内存)                       (IndexedDB)
                            │
                            │ 会话结束
                            ▼
                         清空 ✗
                    (结果已持久化)
```

---

### ADR-003: 批量分析并发模型

#### 背景

批量分析多个内容时，如何控制并发？

#### 决策

**有限并发 + 队列调度**

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          并发模型                                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│                        ┌─────────────────────────┐                      │
│                        │      Task Queue         │                      │
│                        │  ┌───┬───┬───┬───┬───┐ │                      │
│   批量创建任务 ────────▶│  │ T1│ T2│ T3│ T4│ T5│ │                      │
│                        │  └───┴───┴───┴───┴───┘ │                      │
│                        │     pending tasks      │                      │
│                        └───────────┬────────────┘                      │
│                                    │                                    │
│                                    ▼                                    │
│                        ┌─────────────────────────┐                      │
│                        │   Concurrency Gate      │                      │
│                        │      max = 3            │                      │
│                        └───────────┬────────────┘                      │
│                                    │                                    │
│                    ┌───────────────┼───────────────┐                   │
│                    ▼               ▼               ▼                   │
│              ┌─────────┐     ┌─────────┐     ┌─────────┐              │
│              │ Worker 1│     │ Worker 2│     │ Worker 3│              │
│              │ (T1)    │     │ (T2)    │     │ (T3)    │              │
│              └────┬────┘     └────┬────┘     └────┬────┘              │
│                   │               │               │                    │
│                   ▼               ▼               ▼                    │
│              ┌─────────┐     ┌─────────┐     ┌─────────┐              │
│              │   LLM   │     │   LLM   │     │   LLM   │              │
│              │   API   │     │   API   │     │   API   │              │
│              └─────────┘     └─────────┘     └─────────┘              │
│                                                                         │
│   为什么是 3？                                                           │
│   ───────────                                                           │
│   • 太少 (1): 批量分析太慢，用户等待久                                   │
│   • 太多 (10): 可能触发 API 限流，浪费请求                               │
│   • 3 是平衡点: 足够快 + 不易限流                                        │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

### ADR-004: Twitter 适配器回退策略

#### 背景

Twitter DOM 频繁变化，单一选择器不可靠。

#### 决策

**多重选择器 + 降级链**

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       Twitter 适配降级链                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   Level 1: 专用选择器 (data-testid)                                      │
│   ──────────────────────────────────                                    │
│   '[data-testid="tweet"]'                                               │
│   '[data-testid="tweetText"]'                                           │
│           │                                                             │
│           │ 失败                                                        │
│           ▼                                                             │
│   Level 2: 语义选择器 (role)                                             │
│   ─────────────────────────────                                         │
│   'article[role="article"]'                                             │
│   '[lang] span'                                                         │
│           │                                                             │
│           │ 失败                                                        │
│           ▼                                                             │
│   Level 3: 结构特征匹配                                                  │
│   ────────────────────────                                              │
│   'article:has([data-testid="tweetText"])'                              │
│   通过 DOM 结构特征定位                                                  │
│           │                                                             │
│           │ 失败                                                        │
│           ▼                                                             │
│   Level 4: 通用文本提取                                                  │
│   ────────────────────────                                              │
│   Readability.js 提取正文                                               │
│   document.body.innerText                                               │
│           │                                                             │
│           │ 失败                                                        │
│           ▼                                                             │
│   Level 5: 用户手动复制                                                  │
│   ────────────────────────                                              │
│   提示用户复制内容到剪贴板                                               │
│                                                                         │
│   设计意图:                                                              │
│   ─────────                                                             │
│   • 每层都有独立价值，不是简单的 fallback                                 │
│   • Level 1-2 准确度高，Level 3-4 覆盖面广                               │
│   • 监控各层命中率，及时更新选择器                                        │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

### ADR-005: 需求去重触发机制

#### 背景

去重分析应该自动触发还是手动触发？

#### 决策

**用户手动触发 + 频率限制**

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       触发机制对比                                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   方案 A: 每次保存时自动检测                                             │
│   ───────────────────────────                                           │
│   ✗ Token 消耗大（每次都调用 LLM）                                       │
│   ✗ 单条匹配不准确（上下文不足）                                         │
│   ✗ 用户无感知，可能困惑                                                 │
│                                                                         │
│   方案 B: 定时自动分析                                                   │
│   ─────────────────────                                                 │
│   ✗ 用户不知道何时触发                                                   │
│   ✗ 可能在不恰当时机消耗资源                                             │
│   ✗ 结果展示时机难把控                                                   │
│                                                                         │
│   方案 C: 用户主动触发 ✅                                                │
│   ───────────────────────                                               │
│   ✓ 明确的用户意图                                                       │
│   ✓ 成本可预期                                                           │
│   ✓ 结果立即可见                                                         │
│   ✓ 加频率限制（24h）避免滥用                                            │
│                                                                         │
│   触发流程:                                                              │
│   ─────────                                                             │
│                                                                         │
│   用户点击「分析重复」                                                   │
│           │                                                             │
│           ▼                                                             │
│   ┌─────────────────┐                                                   │
│   │ 检查触发条件     │                                                   │
│   │ • 需求数 ≥ 5    │                                                   │
│   │ • 距上次 > 24h  │                                                   │
│   │ • LLM 配置有效  │                                                   │
│   └────────┬────────┘                                                   │
│            │                                                             │
│       条件满足                                                           │
│            │                                                             │
│            ▼                                                             │
│   ┌─────────────────┐                                                   │
│   │ 发送给 LLM 分析  │                                                   │
│   │ (仅必要字段)     │                                                   │
│   └────────┬────────┘                                                   │
│            │                                                             │
│            ▼                                                             │
│   ┌─────────────────┐                                                   │
│   │ 展示分组建议     │                                                   │
│   │ 等待用户确认     │                                                   │
│   └─────────────────┘                                                   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 三、核心数据流

### 3.1 分析任务生命周期

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      AnalysisTask 状态机                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│                          ┌──────────┐                                   │
│                          │  创建    │                                   │
│                          └────┬─────┘                                   │
│                               │                                         │
│                               ▼                                         │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │                                                                 │  │
│   │    ┌─────────┐      ┌────────────┐      ┌──────────┐           │  │
│   │    │ pending │─────▶│ extracting │─────▶│ analyzing│           │  │
│   │    └─────────┘      └────────────┘      └────┬─────┘           │  │
│   │         │                  │                  │                 │  │
│   │         │                  │                  │                 │  │
│   │         │                  │                  ▼                 │  │
│   │         │                  │           ┌───────────┐            │  │
│   │         │                  │           │ completed │            │  │
│   │         │                  │           └───────────┘            │  │
│   │         │                  │                                    │  │
│   │         │ 取消             │ 提取失败        │ 分析失败          │  │
│   │         ▼                  ▼                 ▼                  │  │
│   │    ┌──────────────────────────────────────────────┐            │  │
│   │    │                  error                       │            │  │
│   │    │   (retryable: true/false)                    │            │  │
│   │    └──────────────────────────────────────────────┘            │  │
│   │                                                                 │  │
│   └─────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│   状态转换触发:                                                          │
│   ─────────────                                                         │
│   pending → extracting    : 队列调度器分配 worker                        │
│   extracting → analyzing  : Content Script 返回提取结果                  │
│   analyzing → completed   : LLM 返回分析结果                             │
│   * → error              : 任意阶段发生异常                              │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.2 消息流转架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         跨脚本消息流转                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   ┌──────────────┐                              ┌──────────────┐       │
│   │  Side Panel  │                              │Content Script│       │
│   │   (React)    │                              │  (Adapter)   │       │
│   └──────┬───────┘                              └──────┬───────┘       │
│          │                                             │               │
│          │ ANALYZE_CURRENT_PAGE                        │               │
│          │─────────────────────▶┌──────────────┐       │               │
│          │                      │  Background  │       │               │
│          │                      │   Script     │       │               │
│          │◀─────────────────────┤              ├──────▶│               │
│          │ TASK_CREATED         │  (Message    │ EXTRACT_CONTENT       │
│          │                      │   Handler)   │       │               │
│          │                      │              │◀──────┤               │
│          │◀─────────────────────┤              │ Extraction Result     │
│          │ TASK_STATUS_UPDATED  │              │       │               │
│          │ (extracting)         │              │       │               │
│          │                      │   ┌─────┐    │       │               │
│          │                      │   │ LLM │    │       │               │
│          │                      │   │ API │    │       │               │
│          │                      │   └──┬──┘    │       │               │
│          │◀─────────────────────┤      │       │       │               │
│          │ TASK_STATUS_UPDATED  │◀─────┘       │       │               │
│          │ (analyzing)          │              │       │               │
│          │                      │              │       │               │
│          │◀─────────────────────┤              │       │               │
│          │ TASK_COMPLETED       │              │       │               │
│          │ (result)             │              │       │               │
│          │                      └──────────────┘       │               │
│          │                                             │               │
│                                                                         │
│   关键设计:                                                              │
│   ─────────                                                             │
│   1. Background 是消息中枢，负责路由和业务逻辑                           │
│   2. Side Panel 只负责 UI 渲染和状态展示                                 │
│   3. Content Script 只负责内容提取，无业务逻辑                           │
│   4. 单向数据流: Content → Background → Side Panel                      │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.3 批量分析数据流

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        批量分析数据流                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   用户选择 N 个待分析                                                    │
│          │                                                              │
│          ▼                                                              │
│   ┌─────────────────────────────────────────┐                          │
│   │         批量创建任务                     │                          │
│   │  for each extraction:                   │                          │
│   │    createTask(extraction.source)        │                          │
│   └──────────────────┬──────────────────────┘                          │
│                      │                                                  │
│                      ▼                                                  │
│   ┌─────────────────────────────────────────┐                          │
│   │         任务队列                         │                          │
│   │  [T1:pending, T2:pending, ..., TN:pending]                         │
│   └──────────────────┬──────────────────────┘                          │
│                      │                                                  │
│                      ▼                                                  │
│   ┌─────────────────────────────────────────┐                          │
│   │         并发控制器                       │                          │
│   │  while (pending.length > 0):            │                          │
│   │    if (running < 3):                    │                          │
│   │      processNext()                      │                          │
│   └──────────────────┬──────────────────────┘                          │
│                      │                                                  │
│          ┌──────────┼──────────┐                                       │
│          ▼          ▼          ▼                                       │
│      ┌───────┐  ┌───────┐  ┌───────┐                                  │
│      │ T1    │  │ T2    │  │ T3    │  (并发执行)                       │
│      │analyze│  │analyze│  │analyze│                                  │
│      └───┬───┘  └───┬───┘  └───┬───┘                                  │
│          │          │          │                                       │
│          ▼          ▼          ▼                                       │
│      完成/失败   完成/失败   完成/失败                                   │
│          │          │          │                                       │
│          └──────────┼──────────┘                                       │
│                     │                                                   │
│                     ▼                                                   │
│   ┌─────────────────────────────────────────┐                          │
│   │         释放 worker slot                │                          │
│   │         处理下一个 pending               │                          │
│   └──────────────────┬──────────────────────┘                          │
│                      │                                                  │
│                      ▼                                                  │
│   ┌─────────────────────────────────────────┐                          │
│   │         全部完成                         │                          │
│   │         汇总通知用户                      │                          │
│   └─────────────────────────────────────────┘                          │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 四、关键设计模式

### 4.1 适配器模式 (Adapter Pattern)

**应用场景**: 平台内容提取

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         适配器架构                                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│                        ┌─────────────────┐                              │
│                        │   BaseAdapter   │                              │
│                        │   (abstract)    │                              │
│                        ├─────────────────┤                              │
│                        │ + canHandle()   │                              │
│                        │ + getPageInfo() │                              │
│                        │ + extract()     │                              │
│                        └────────┬────────┘                              │
│                                 │                                       │
│           ┌─────────────────────┼─────────────────────┐                │
│           │                     │                     │                │
│           ▼                     ▼                     ▼                │
│   ┌───────────────┐    ┌───────────────┐    ┌───────────────┐         │
│   │ RedditAdapter │    │ ZhihuAdapter  │    │TwitterAdapter │         │
│   ├───────────────┤    ├───────────────┤    ├───────────────┤         │
│   │ canHandle()   │    │ canHandle()   │    │ canHandle()   │         │
│   │ → reddit.com  │    │ → zhihu.com   │    │ → x.com       │         │
│   │ extract()     │    │ extract()     │    │ extract()     │         │
│   │ → 帖子+评论   │    │ → 问答内容    │    │ → 推文+回复   │         │
│   └───────────────┘    └───────────────┘    └───────────────┘         │
│           │                     │                     │                │
│           └─────────────────────┼─────────────────────┘                │
│                                 │                                       │
│                                 ▼                                       │
│                        ┌─────────────────┐                              │
│                        │ AdapterRegistry │                              │
│                        ├─────────────────┤                              │
│                        │ + register()    │                              │
│                        │ + getAdapter()  │                              │
│                        │ → 根据 URL 匹配 │                              │
│                        └─────────────────┘                              │
│                                                                         │
│   设计意图:                                                              │
│   ─────────                                                             │
│   1. 新增平台只需添加新 Adapter，不改动核心逻辑                          │
│   2. 每个 Adapter 独立维护选择器，便于快速响应平台变化                    │
│   3. Registry 统一管理，支持动态注册                                     │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 4.2 观察者模式 (Observer Pattern)

**应用场景**: 任务状态变化通知 UI

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       状态订阅机制                                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   ┌────────────────────────────────────────────────────────────────┐   │
│   │                     Zustand Store                              │   │
│   │  ┌──────────────────────────────────────────────────────────┐  │   │
│   │  │                   State                                  │  │   │
│   │  │  tasks: [                                                │  │   │
│   │  │    { id: 't1', status: 'analyzing', ... },              │  │   │
│   │  │    { id: 't2', status: 'completed', ... },              │  │   │
│   │  │  ]                                                       │  │   │
│   │  └────────────────────────┬─────────────────────────────────┘  │   │
│   │                           │                                    │   │
│   │                     状态变化                                    │   │
│   │                           │                                    │   │
│   └───────────────────────────┼────────────────────────────────────┘   │
│                               │                                        │
│               ┌───────────────┼───────────────┐                       │
│               │               │               │                       │
│               ▼               ▼               ▼                       │
│   ┌───────────────┐ ┌───────────────┐ ┌───────────────┐              │
│   │ TaskIndicator │ │  TaskList     │ │ AnalysisView  │              │
│   │               │ │               │ │               │              │
│   │ useStore(     │ │ useStore(     │ │ useStore(     │              │
│   │   s=>s.tasks  │ │   s=>s.tasks  │ │   s=>active   │              │
│   │ )             │ │ )             │ │   Task        │              │
│   │               │ │               │ │ )             │              │
│   └───────────────┘ └───────────────┘ └───────────────┘              │
│                                                                        │
│   设计意图:                                                             │
│   ─────────                                                            │
│   1. 细粒度订阅: 组件只订阅需要的状态片段                                │
│   2. 自动重渲染: 状态变化自动触发相关组件更新                            │
│   3. 性能优化: selector 避免不必要的重渲染                               │
│                                                                        │
└─────────────────────────────────────────────────────────────────────────┘
```

### 4.3 策略模式 (Strategy Pattern)

**应用场景**: 选择器降级策略

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       选择器策略链                                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   interface SelectorStrategy {                                          │
│     name: string;                                                       │
│     priority: number;                                                   │
│     select(doc: Document): Element[];                                   │
│   }                                                                     │
│                                                                         │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │                    TwitterAdapter                               │  │
│   │                                                                 │  │
│   │   strategies: [                                                 │  │
│   │     { name: 'testid',   priority: 1, select: ... },            │  │
│   │     { name: 'semantic', priority: 2, select: ... },            │  │
│   │     { name: 'structure',priority: 3, select: ... },            │  │
│   │   ]                                                             │  │
│   │                                                                 │  │
│   │   extract() {                                                   │  │
│   │     for (strategy of sortByPriority(strategies)) {             │  │
│   │       result = strategy.select(document)                       │  │
│   │       if (result.length > 0) {                                 │  │
│   │         log.info(`${strategy.name} matched`)                   │  │
│   │         return result                                          │  │
│   │       }                                                         │  │
│   │     }                                                           │  │
│   │     return fallbackExtract()                                    │  │
│   │   }                                                             │  │
│   │                                                                 │  │
│   └─────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│   设计意图:                                                              │
│   ─────────                                                             │
│   1. 策略独立: 每种选择器是独立策略，便于增删改                          │
│   2. 优先级控制: 高准确度策略优先尝试                                    │
│   3. 可观测: 记录哪种策略命中，便于监控和优化                            │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 五、状态管理架构

### 5.1 Store 拆分策略

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         Store 架构                                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   ┌─────────────────────────────────────────────────────────────────┐  │
│   │                      Zustand Stores                             │  │
│   │                                                                 │  │
│   │   ┌─────────────────┐  ┌─────────────────┐  ┌────────────────┐ │  │
│   │   │ useAnalysisStore│  │ useDemandsStore │  │ useConfigStore │ │  │
│   │   ├─────────────────┤  ├─────────────────┤  ├────────────────┤ │  │
│   │   │ 职责:           │  │ 职责:           │  │ 职责:          │ │  │
│   │   │ • 当前页面      │  │ • 需求 CRUD     │  │ • LLM 配置     │ │  │
│   │   │ • 分析任务队列  │  │ • 分组管理      │  │ • 站点白名单   │ │  │
│   │   │ • 任务状态      │  │ • 搜索筛选      │  │ • 存储统计     │ │  │
│   │   │                 │  │ • 去重状态      │  │                │ │  │
│   │   ├─────────────────┤  ├─────────────────┤  ├────────────────┤ │  │
│   │   │ 持久化: ✗       │  │ 持久化: ✓       │  │ 持久化: ✓      │ │  │
│   │   │ (内存)          │  │ (IndexedDB)     │  │ (chrome.storage│ │  │
│   │   └─────────────────┘  └─────────────────┘  └────────────────┘ │  │
│   │                                                                 │  │
│   └─────────────────────────────────────────────────────────────────┘  │
│                                                                         │
│   拆分原则:                                                              │
│   ─────────                                                             │
│   1. 按领域拆分: 分析、需求、配置 是独立业务领域                         │
│   2. 按生命周期拆分: 临时状态 vs 持久化数据                              │
│   3. 最小化跨 store 依赖: 减少状态同步复杂度                             │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 5.2 状态更新流程

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      单向数据流                                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│                                                                         │
│   用户操作                                                               │
│      │                                                                  │
│      ▼                                                                  │
│   ┌─────────────────┐                                                   │
│   │   UI 组件       │                                                   │
│   │   (React)       │                                                   │
│   └────────┬────────┘                                                   │
│            │ dispatch action                                            │
│            ▼                                                            │
│   ┌─────────────────┐                                                   │
│   │   Store Action  │                                                   │
│   │   (Zustand)     │                                                   │
│   └────────┬────────┘                                                   │
│            │                                                            │
│     ┌──────┴──────┐                                                     │
│     │             │                                                     │
│     ▼             ▼                                                     │
│ ┌────────┐  ┌──────────────┐                                           │
│ │ 同步   │  │ 异步          │                                           │
│ │ 更新   │  │ (Background)  │                                           │
│ │ State  │  └───────┬───────┘                                           │
│ └───┬────┘          │                                                   │
│     │               │ 完成后                                            │
│     │               │                                                   │
│     │          ┌────┴─────┐                                             │
│     │          │ 消息通知  │                                             │
│     │          │ Side Panel│                                             │
│     │          └────┬─────┘                                             │
│     │               │                                                   │
│     └───────────────┤                                                   │
│                     ▼                                                   │
│            ┌─────────────────┐                                          │
│            │   State 更新    │                                          │
│            └────────┬────────┘                                          │
│                     │ 触发订阅                                          │
│                     ▼                                                   │
│            ┌─────────────────┐                                          │
│            │   UI 重渲染     │                                          │
│            └─────────────────┘                                          │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 六、错误处理策略

### 6.1 错误分类与恢复

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         错误处理矩阵                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   错误类型           可恢复?    自动重试?    用户操作                    │
│   ─────────────────────────────────────────────────────────────────     │
│   网络超时            ✓          ✓ (1次)     等待 / 手动重试            │
│   API 认证失败        ✗          ✗           检查配置                   │
│   API 额度耗尽        ✗          ✗           充值 / 等待重置            │
│   内容提取失败        ✓          ✗           手动复制                   │
│   LLM 返回格式错误    ✓          ✓ (1次)     手动重试                   │
│   存储空间不足        ✗          ✗           清理数据                   │
│                                                                         │
│   错误恢复流程:                                                          │
│   ─────────────                                                         │
│                                                                         │
│   ┌───────────┐     ┌─────────────┐     ┌─────────────┐               │
│   │   错误    │────▶│  分类判断   │────▶│  恢复策略   │               │
│   │   发生    │     │             │     │             │               │
│   └───────────┘     └──────┬──────┘     └──────┬──────┘               │
│                            │                    │                      │
│                    ┌───────┴───────┐           │                      │
│                    │               │           │                      │
│                    ▼               ▼           ▼                      │
│              ┌──────────┐   ┌──────────┐  ┌──────────┐               │
│              │ 可自动   │   │ 需用户   │  │ 无法恢复 │               │
│              │ 重试     │   │ 介入     │  │ (记录)   │               │
│              └────┬─────┘   └────┬─────┘  └──────────┘               │
│                   │              │                                    │
│                   ▼              ▼                                    │
│              ┌──────────┐   ┌──────────┐                             │
│              │ 自动重试 │   │ 显示错误 │                             │
│              │ (最多1次)│   │ + 操作   │                             │
│              └──────────┘   └──────────┘                             │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 七、性能考量

### 7.1 性能边界

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         性能边界定义                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   场景                      边界值           超出后行为                  │
│   ─────────────────────────────────────────────────────────────────     │
│   任务队列大小              20 个            自动清理最早完成的          │
│   单次批量分析              20 个            提示分批处理                │
│   需求库去重分析            200 个           分页处理                    │
│   Twitter 提取推文          30 条            截取可见部分                │
│   内容截断                  20000 字符       显示截断提示                │
│                                                                         │
│   内存占用预算:                                                          │
│   ─────────────                                                         │
│                                                                         │
│   ┌─────────────────────────────────────────────────────────────┐      │
│   │                     总预算: 150MB                           │      │
│   ├─────────────────────────────────────────────────────────────┤      │
│   │ Background Script (常驻)          │ 50MB                    │      │
│   │ Side Panel (打开时)               │ 40MB                    │      │
│   │ Content Script (每标签页)         │ 20MB                    │      │
│   │ 任务队列 (20个任务)               │ 10MB                    │      │
│   │ 缓冲                              │ 30MB                    │      │
│   └─────────────────────────────────────────────────────────────┘      │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 7.2 优化策略

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         性能优化策略                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   1. 虚拟滚动 (需求列表)                                                 │
│      ─────────────────────                                              │
│      • 仅渲染可见区域的 20 条                                            │
│      • 滚动时动态替换                                                    │
│      • 库: @tanstack/react-virtual                                      │
│                                                                         │
│   2. 防抖 (搜索输入)                                                     │
│      ───────────────                                                    │
│      • 300ms 防抖                                                        │
│      • 减少无谓的筛选计算                                                │
│                                                                         │
│   3. 惰性加载 (分组详情)                                                 │
│      ─────────────────                                                  │
│      • 分组仅显示摘要                                                    │
│      • 展开时再加载完整需求                                              │
│                                                                         │
│   4. 增量更新 (任务状态)                                                 │
│      ─────────────────                                                  │
│      • 只更新变化的任务                                                  │
│      • 不重新渲染整个列表                                                │
│                                                                         │
│   5. Web Worker (去重分析准备)                                           │
│      ─────────────────────────                                          │
│      • 数据预处理在 Worker 中                                            │
│      • 不阻塞主线程                                                      │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 八、测试策略

### 8.1 测试金字塔

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         测试金字塔                                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│                           /\                                            │
│                          /  \                                           │
│                         /    \                                          │
│                        / E2E  \        数量: 少                         │
│                       / Tests  \       成本: 高                         │
│                      /   (5)    \      覆盖: 关键路径                    │
│                     /────────────\                                      │
│                    /              \                                     │
│                   /  Integration   \   数量: 中                         │
│                  /    Tests (20)    \  成本: 中                         │
│                 /                    \ 覆盖: 模块交互                    │
│                /──────────────────────\                                 │
│               /                        \                                │
│              /      Unit Tests (50)     \  数量: 多                     │
│             /                            \ 成本: 低                     │
│            /                              \覆盖: 函数逻辑                │
│           /────────────────────────────────\                            │
│                                                                         │
│   各层测试重点:                                                          │
│   ─────────────                                                         │
│                                                                         │
│   Unit Tests:                                                           │
│   • TaskQueue 并发控制                                                   │
│   • Adapter 选择器逻辑                                                   │
│   • Store actions                                                       │
│   • PII 过滤规则                                                        │
│                                                                         │
│   Integration Tests:                                                    │
│   • Background ↔ Side Panel 消息                                        │
│   • Store 状态流转                                                       │
│   • IndexedDB CRUD                                                      │
│                                                                         │
│   E2E Tests:                                                            │
│   • 完整分析流程                                                         │
│   • 批量分析流程                                                         │
│   • 去重确认流程                                                         │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 九、变更影响分析

### 9.1 向后兼容性

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       向后兼容性分析                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   用户数据迁移: 不需要                                                   │
│   ─────────────────────                                                 │
│   • Extraction 模型不变                                                  │
│   • Demand 模型仅新增可选字段 (groupId, groupName)                       │
│   • 现有数据自动兼容，groupId 为 undefined 即独立需求                    │
│                                                                         │
│   API 兼容性: 完全兼容                                                   │
│   ────────────────────                                                  │
│   • 不修改 LLM 调用方式                                                  │
│   • 新增 Prompt 是增量                                                   │
│                                                                         │
│   UI 兼容性: 渐进增强                                                    │
│   ──────────────────                                                    │
│   • 现有功能入口不变                                                     │
│   • 新功能作为新增入口                                                   │
│   • 任务指示器仅在有任务时显示                                           │
│                                                                         │
│   Store 迁移:                                                            │
│   ───────────                                                           │
│   ┌─────────────────────────────────────────────────────────────┐      │
│   │                                                             │      │
│   │   v2.0 state              v2.1 state                        │      │
│   │   ──────────              ──────────                        │      │
│   │   pageInfo       ──▶      currentPage                       │      │
│   │   status         ──▶      tasks[activeTask].status          │      │
│   │   demands        ──▶      tasks[activeTask].result.demands  │      │
│   │   (其他字段废弃)                                              │      │
│   │                                                             │      │
│   │   迁移策略: 不迁移，内存状态重启后重新初始化                  │      │
│   │                                                             │      │
│   └─────────────────────────────────────────────────────────────┘      │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 十、决策日志

| 日期 | 决策 | 理由 | 决策者 |
|-----|------|------|-------|
| 2025-12-10 | 任务存储在内存，不持久化 | 简化实现，结果已持久化 | - |
| 2025-12-10 | 批量分析并发数设为 3 | 平衡速度与 API 限流 | - |
| 2025-12-10 | 去重分析用户主动触发 | 成本可控，意图明确 | - |
| 2025-12-10 | Twitter 采用多重选择器 | DOM 频繁变化，需要回退 | - |
| 2025-12-10 | 任务队列上限 20 个 | 内存预算控制 | - |

---

**文档结束**

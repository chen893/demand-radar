# Demand Radar v2.1 - 迭代需求文档

> 版本: 2.1
> 更新日期: 2025-12-10
> 基于版本: PRD 2.0
> 迭代代号: **多任务 + 规模化**
> 文档状态: 草稿

---

## 一、迭代概述

### 1.1 迭代背景

PRD 2.0 已完成 MVP 核心功能，用户可以在 Reddit/知乎上分析页面并提炼产品方向。但在实际使用中发现一个关键体验问题：

**问题现象**：
- 用户在页面 A 点击「分析此页面」，分析正在进行中
- 用户切换到页面 B（习惯性浏览行为）
- Side Panel 状态被重置，页面 A 的分析结果**丢失**
- 用户需要返回页面 A 重新分析，浪费时间和 API 费用

**问题根因**：
当前架构将「当前页面」与「分析状态」强绑定，URL 变化会触发状态重置。

**扩展需求**：
随着 MVP 上线，用户开始提出更多需求：
- 「能不能一次分析多个待分析的内容？」→ 批量分析
- 「Twitter 上也有很多需求吐槽，能支持吗？」→ 平台扩展
- 「积累了 50 个方向，好像有重复的？」→ 需求去重

### 1.2 迭代目标

| 目标 | 描述 | 成功标准 |
|-----|------|---------|
| **体验修复** | 分析任务不因页面切换而丢失 | 切换页面后分析继续完成，用户可查看结果 |
| **效率提升** | 支持批量分析待分析内容 | 一次操作处理多个内容，节省操作时间 |
| **来源扩展** | 新增 Twitter/X 平台支持 | 可从 Twitter 提取需求信号 |
| **模式发现** | 从积累的需求中发现重复模式 | 自动识别相似需求，验证市场信号 |

### 1.3 功能逻辑闭环

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           用户价值闭环                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   【快速捕获】              【多源采集】              【模式发现】        │
│                                                                         │
│  ┌──────────────┐        ┌──────────────┐        ┌──────────────┐      │
│  │ 分析任务独立化 │───────▶│ Twitter/X    │───────▶│ 需求去重分析  │      │
│  │ + 批量分析    │        │ 适配         │        │              │      │
│  └──────────────┘        └──────────────┘        └──────────────┘      │
│         │                       │                       │              │
│         ▼                       ▼                       ▼              │
│  ┌──────────────────────────────────────────────────────────────┐      │
│  │                                                              │      │
│  │  用户可以：                                                   │      │
│  │  1. 边浏览边分析，不担心丢失（任务独立化）                      │      │
│  │  2. 积累待分析内容后一次性批量处理（批量分析）                  │      │
│  │  3. 从 Twitter 获取更多需求信号（平台扩展）                    │      │
│  │  4. 发现反复出现的产品机会（去重分析）                         │      │
│  │                                                              │      │
│  └──────────────────────────────────────────────────────────────┘      │
│                                                                         │
│   【核心价值】让需求雷达从「单点捕获」进化为「规模化发现」               │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

**功能协同关系**：

| 功能 | 依赖 | 协同价值 |
|-----|------|---------|
| 分析任务独立化 | 无（基础设施） | 为批量分析提供任务队列基础 |
| 批量分析 | 任务独立化 | 复用任务队列，支持多任务并行 |
| Twitter/X 适配 | 无 | 扩展数据来源，加速需求积累 |
| 需求去重分析 | 需求库有足够数据 | 从积累中发现模式，验证信号 |

### 1.4 与 v2.0 的关系

| 方面 | v2.0 MVP | v2.1 本迭代 |
|-----|---------|------------|
| **分析模式** | 单任务，绑定当前页面 | 多任务，独立于页面 |
| **处理方式** | 单个页面逐个分析 | 支持批量分析 |
| **平台支持** | Reddit + 知乎 | + Twitter/X |
| **需求管理** | 列表 + 搜索 + 标签 | + 去重分析 + 分组 |
| **数据模型** | Extraction + Demand | + AnalysisTask |

**向后兼容**：
- 本迭代不修改 Extraction 和 Demand 模型的核心字段
- 新增 AnalysisTask 模型，与现有模型并存
- 用户无感知升级，历史数据完整保留

### 1.5 迭代范围

#### 包含（In Scope）

- [x] **分析任务独立化**：分析任务独立于页面切换，支持后台完成
- [x] **任务指示器 UI**：显示进行中/已完成的分析任务
- [x] **批量分析**：一次分析多个「待分析」状态的内容
- [x] **Twitter/X 适配**：支持 Twitter 帖子和回复的内容提取（受限）
- [x] **需求去重分析**：LLM 分析相似需求，用户确认后合并分组

#### 不包含（Out of Scope）

- [ ] 云端同步 / 账户系统 → 保持 P1 后续迭代
- [ ] Hacker News 适配 → 保持 P1 后续迭代
- [ ] 自定义快捷键 → 保持 P1 后续迭代
- [ ] 实时监听页面变化自动分析 → 不做，保持用户主动触发
- [ ] Twitter 登录态获取私密内容 → 不做，仅支持公开内容

---

## 二、核心改进：分析任务独立化

### 2.1 问题诊断

**当前实现**（`src/sidepanel/stores/analysis.ts`）：

```typescript
// 问题代码：URL 变化时重置所有分析状态
setPageInfo: (info) => {
  const currentInfo = get().pageInfo;
  if (currentInfo?.url !== info?.url) {
    set({
      pageInfo: info,
      status: "idle",        // ← 问题：强制重置为 idle
      error: null,
      extractionId: null,
      summary: null,
      demands: [],           // ← 问题：清空分析结果
      selectedDemandIds: [],
    });
  }
}
```

**问题影响**：

| 场景 | 当前行为 | 用户期望 |
|-----|---------|---------|
| 分析中切换页面 | 分析被中断，结果丢失 | 分析继续完成，可查看结果 |
| 分析中刷新页面 | 状态重置 | 保持分析状态 |
| 同时想分析多个页面 | 不支持 | 支持队列化处理 |

### 2.2 设计目标

| 目标 | 描述 | 衡量标准 |
|-----|------|---------|
| **任务不丢失** | 触发的分析任务必须完成 | 切换页面后分析成功率 100% |
| **结果可追溯** | 完成的分析结果可以查看 | 用户可在任务列表中查看任意已完成任务 |
| **状态可感知** | 用户知道有多少任务在进行 | 任务指示器实时显示状态 |
| **体验流畅** | 不打断用户正常浏览 | 分析在后台进行，不阻塞交互 |

### 2.3 概念模型变更

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         概念模型对比                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  【v2.0 当前模型】                                                       │
│  ┌─────────────────────────────────────────────────────────────┐       │
│  │                    Side Panel                               │       │
│  │  ┌───────────────────────────────────────────────────────┐  │       │
│  │  │  pageInfo ←bindTo→ analysisStatus                     │  │       │
│  │  │     ↑                       ↑                         │  │       │
│  │  │     │                       │                         │  │       │
│  │  │  URL变化 ════════════════▶ 状态重置                    │  │       │
│  │  └───────────────────────────────────────────────────────┘  │       │
│  └─────────────────────────────────────────────────────────────┘       │
│                                                                         │
│  【v2.1 新模型】                                                         │
│  ┌─────────────────────────────────────────────────────────────┐       │
│  │                    Side Panel                               │       │
│  │  ┌─────────────────┐    ┌─────────────────────────────┐    │       │
│  │  │   currentPage   │    │      AnalysisTask[]         │    │       │
│  │  │   (当前页面)     │    │      (任务队列)              │    │       │
│  │  │        ↑        │    │  ┌─────┐ ┌─────┐ ┌─────┐   │    │       │
│  │  │    URL变化      │    │  │Task1│ │Task2│ │Task3│   │    │       │
│  │  │    仅更新此处   │    │  │完成 │ │进行中│ │待处理│   │    │       │
│  │  └─────────────────┘    │  └─────┘ └─────┘ └─────┘   │    │       │
│  │          ↓              │           ↑                │    │       │
│  │     显示入口区域         │      独立生命周期           │    │       │
│  └─────────────────────────────────────────────────────────────┘       │
│                                                                         │
│  核心变化：「当前页面」与「分析任务」解耦                                  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2.4 数据模型：AnalysisTask

```typescript
/**
 * 分析任务 - 独立于页面的分析单元
 * 存储位置: Zustand store（内存），不持久化到 IndexedDB
 * 生命周期: 浏览器会话内有效，关闭后清空
 */
interface AnalysisTask {
  // === 任务标识 ===
  id: string;                              // UUID，任务唯一标识

  // === 来源信息（创建时快照）===
  source: {
    url: string;                           // 触发分析的页面 URL
    title: string;                         // 页面标题
    platform: 'reddit' | 'zhihu' | 'twitter' | 'generic';
    favicon?: string;                      // 网站图标（可选）
  };

  // === 任务状态 ===
  status: 'pending' | 'extracting' | 'analyzing' | 'completed' | 'error';
  progress?: number;                       // 0-100，仅 analyzing 状态使用

  // === 时间戳 ===
  createdAt: Date;                         // 任务创建时间
  startedAt?: Date;                        // 开始处理时间
  completedAt?: Date;                      // 完成时间

  // === 分析结果（completed 状态填充）===
  result?: {
    extractionId: string;                  // 关联的 Extraction ID
    summary: string;                       // 内容摘要
    demands: DemandPreview[];              // 识别的产品方向
  };

  // === 错误信息（error 状态填充）===
  error?: {
    code: string;                          // 错误码
    message: string;                       // 错误信息
    retryable: boolean;                    // 是否可重试
  };
}

/**
 * 任务状态流转
 *
 *   pending ──▶ extracting ──▶ analyzing ──▶ completed
 *      │            │              │
 *      └────────────┴──────────────┴──────▶ error
 */
```

### 2.5 状态管理重构

```typescript
// src/sidepanel/stores/analysis.ts 重构

interface AnalysisState {
  // ===== 当前页面（随 URL 变化更新）=====
  currentPage: PageInfoPayload | null;

  // ===== 任务队列（独立于页面切换）=====
  tasks: AnalysisTask[];                   // 所有任务（最多保留 20 个）
  activeTaskId: string | null;             // 当前查看的任务 ID

  // ===== 任务指示器状态 =====
  indicatorExpanded: boolean;              // 指示器是否展开

  // ===== Actions =====

  // 页面相关
  setCurrentPage: (info: PageInfoPayload | null) => void;

  // 任务相关
  createTask: (source: AnalysisTask['source']) => string;  // 返回 taskId
  updateTaskStatus: (taskId: string, status: AnalysisTask['status'], data?: Partial<AnalysisTask>) => void;
  setTaskResult: (taskId: string, result: AnalysisTask['result']) => void;
  setTaskError: (taskId: string, error: AnalysisTask['error']) => void;
  retryTask: (taskId: string) => void;
  cancelTask: (taskId: string) => void;

  // 视图相关
  viewTask: (taskId: string | null) => void;              // 切换查看某个任务
  toggleIndicator: () => void;                            // 展开/收起指示器
  clearCompletedTasks: () => void;                        // 清理已完成任务

  // 查询
  getRunningTasks: () => AnalysisTask[];                  // 获取进行中的任务
  getCompletedTasks: () => AnalysisTask[];                // 获取已完成的任务
  getTaskForUrl: (url: string) => AnalysisTask | undefined; // 查找某 URL 的任务
}
```

**核心逻辑变更**：

```typescript
// 【变更前】URL 变化重置所有状态
setPageInfo: (info) => {
  if (currentInfo?.url !== info?.url) {
    set({ status: "idle", demands: [], ... });  // 全部重置
  }
}

// 【变更后】URL 变化仅更新 currentPage
setCurrentPage: (info) => {
  set({ currentPage: info });

  // 检查是否有该 URL 的已完成任务，自动关联
  const existingTask = get().tasks.find(
    t => t.source.url === info?.url && t.status === 'completed'
  );
  if (existingTask) {
    set({ activeTaskId: existingTask.id });
  } else {
    set({ activeTaskId: null });  // 无关联任务时清空
  }
}
```

### 2.6 UI 交互设计

#### 2.6.1 任务指示器（收起状态）

```
┌─────────────────────────────────────────┐
│ Demand Radar           [需求库] [设置]   │
├─────────────────────────────────────────┤
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │ 🔄 1 个分析进行中              [▼] │ │  ← 任务指示器
│ └─────────────────────────────────────┘ │
│                                         │
│ 📄 当前页面                              │
│ ┌─────────────────────────────────────┐ │
│ │ r/SaaS - Why is there no good...   │ │
│ │ reddit.com · 可分析                 │ │
│ └─────────────────────────────────────┘ │
│                                         │
│       ┌─────────────────────┐          │
│       │   🔍 分析此页面     │          │
│       └─────────────────────┘          │
│                                         │
└─────────────────────────────────────────┘
```

**指示器状态变化**：

| 状态 | 显示内容 | 样式 |
|-----|---------|------|
| 无任务 | 不显示指示器 | - |
| 有进行中 | 「🔄 N 个分析进行中」 | 蓝色，带脉冲动画 |
| 全部完成 | 「✅ N 个分析已完成」 | 绿色，3秒后收起 |
| 有失败 | 「⚠️ N 个分析失败」 | 橙色 |

#### 2.6.2 任务指示器（展开状态）

```
┌─────────────────────────────────────────┐
│ 🔄 分析任务                      [收起] │
├─────────────────────────────────────────┤
│                                         │
│ ⏳ 进行中 (1)                            │
│ ┌─────────────────────────────────────┐ │
│ │ 🔵 r/SaaS - Why is there no...     │ │
│ │    ████████░░░░ 分析中 67%          │ │
│ │    [取消]                           │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ ✅ 已完成 (2)                            │
│ ┌─────────────────────────────────────┐ │
│ │ 知乎 - 为什么国内没有好用的...       │ │
│ │ 2分钟前 · 识别到 3 个方向           │ │
│ │ [查看结果]                          │ │
│ └─────────────────────────────────────┘ │
│ ┌─────────────────────────────────────┐ │
│ │ r/Entrepreneur - Looking for...     │ │
│ │ 5分钟前 · 识别到 1 个方向           │ │
│ │ [查看结果]                          │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ ❌ 失败 (1)                              │
│ ┌─────────────────────────────────────┐ │
│ │ Twitter - @indie_dev...             │ │
│ │ API 额度不足                        │ │
│ │ [重试] [删除]                       │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ ─────────────────────────────────────── │
│ [清除已完成]                             │
└─────────────────────────────────────────┘
```

#### 2.6.3 任务完成通知

当任务在后台完成时，显示 Toast 通知：

```
┌─────────────────────────────────────────┐
│ ✅ 分析完成                        [×]  │
│ r/SaaS - Why is there no good...       │
│ 识别到 2 个产品方向                     │
│ [查看结果]                              │
└─────────────────────────────────────────┘
```

**通知策略**：
- 在当前页面完成：直接显示结果
- 在其他页面完成：Toast 通知 + 指示器更新
- 5 秒后自动消失，点击「查看结果」跳转

### 2.7 关键交互流程

#### 场景 1：分析中切换页面

```
时间线：
───────────────────────────────────────────────────────────────────▶

T0: 用户在页面 A 点击「分析此页面」
    └─▶ 创建 Task { id: "task-1", source: A, status: "extracting" }
    └─▶ 指示器显示「🔄 1 个分析进行中」

T1: 用户切换到页面 B
    └─▶ setCurrentPage(B)  // 仅更新 currentPage
    └─▶ task-1 继续在后台运行（不受影响）
    └─▶ 指示器仍显示「🔄 1 个分析进行中」
    └─▶ 当前页面区域显示页面 B 信息

T2: task-1 分析完成
    └─▶ updateTaskStatus("task-1", "completed", { result: ... })
    └─▶ 指示器变为「✅ 1 个分析已完成」
    └─▶ Toast 通知「页面 A 分析完成，识别到 2 个方向」

T3: 用户点击 Toast 或指示器中的「查看结果」
    └─▶ viewTask("task-1")
    └─▶ 显示 task-1 的分析结果（来自页面 A）
```

#### 场景 2：返回原页面自动关联

```
时间线：
───────────────────────────────────────────────────────────────────▶

T0: 用户在页面 A 完成分析，结果存在 task-1

T1: 用户切换到页面 B
    └─▶ 当前页面显示 B，activeTaskId = null

T2: 用户切换回页面 A
    └─▶ setCurrentPage(A)
    └─▶ 检测到 task-1.source.url === A.url
    └─▶ 自动设置 activeTaskId = "task-1"
    └─▶ 显示 task-1 的分析结果（无需重新分析）
```

### 2.8 边界场景处理

| 场景 | 处理方式 | 用户感知 |
|-----|---------|---------|
| **关闭浏览器** | 任务队列清空（内存存储） | 重新打开后无历史任务，分析结果已保存在 Extraction |
| **同一页面重复分析** | 提示「该页面已有分析结果，是否重新分析？」 | 可选覆盖或查看历史 |
| **任务队列满（20个）** | 自动清理最早的已完成任务 | 无感知 |
| **分析超时（60s）** | 标记为 error，提示「分析超时」 | 可重试 |
| **API 额度不足** | 标记为 error，提示「API 额度不足」 | 引导检查账户 |
| **网络断开** | 标记为 error，提示「网络连接失败」 | 恢复后可重试 |
| **批量分析中取消单个** | 仅取消该任务，其他继续 | 该任务标记为 cancelled |

### 2.9 验收标准

| 验收项 | 标准 | 测试方法 |
|-------|------|---------|
| 页面切换不丢失 | 切换页面后分析任务继续完成 | 触发分析 → 切换页面 → 等待完成 → 检查结果 |
| 任务状态正确 | 状态流转符合预期 | 检查各状态下的 UI 显示 |
| 指示器显示正确 | 数量和状态与实际一致 | 多任务场景下检查显示 |
| 完成通知及时 | 完成后 1 秒内显示 Toast | 计时测试 |
| 自动关联生效 | 返回原页面自动显示结果 | A→B→A 切换测试 |
| 任务可取消 | 进行中的任务可取消 | 点击取消按钮测试 |
| 错误可重试 | 失败的任务可重试 | 模拟错误后点击重试 |
| 队列限制生效 | 超过 20 个自动清理 | 创建 25 个任务检查 |

---

## 三、功能一：批量分析

### 3.1 功能定位

批量分析是对「快速保存」功能的自然延伸：
- MVP 中用户可以「快速保存」（不调用 LLM），将内容标记为「待分析」
- 积累多个待分析内容后，用户希望一次性批量处理
- 批量分析复用「分析任务独立化」的任务队列机制

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         批量分析定位                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   用户浏览多个页面                                                       │
│        │                                                                │
│        ▼                                                                │
│   ┌─────────────────────────────────────────────────────────────┐      │
│   │  快速保存 × N                                                │      │
│   │  （不调用 LLM，零成本积累原始素材）                           │      │
│   └─────────────────────────────────────────────────────────────┘      │
│        │                                                                │
│        ▼                                                                │
│   ┌─────────────────────────────────────────────────────────────┐      │
│   │  需求库积累了 N 个「待分析」状态的 Extraction                 │      │
│   └─────────────────────────────────────────────────────────────┘      │
│        │                                                                │
│        ▼                                                                │
│   ┌─────────────────────────────────────────────────────────────┐      │
│   │  批量分析                                                    │      │
│   │  （一次性处理多个待分析内容，复用任务队列）                    │      │
│   └─────────────────────────────────────────────────────────────┘      │
│        │                                                                │
│        ▼                                                                │
│   ┌─────────────────────────────────────────────────────────────┐      │
│   │  所有内容分析完成，产出多个产品方向                           │      │
│   └─────────────────────────────────────────────────────────────┘      │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.2 用户场景

> **用户**：独立开发者小李
> **场景**：周末花 2 小时浏览 Reddit，快速保存了 15 个感兴趣的帖子
> **行为**：打开需求库，点击「批量分析待处理内容」
> **结果**：
> - 系统创建 15 个分析任务，加入任务队列
> - 任务指示器显示进度「🔄 分析中 3/15」
> - 小李可以继续浏览其他页面，分析在后台进行
> - 全部完成后收到通知「15 个内容分析完成，识别到 23 个产品方向」
> **价值**：批量处理节省操作时间，后台执行不打断工作流

### 3.3 功能设计

#### 3.3.1 触发入口

**入口 1：需求库页面**

```
┌─────────────────────────────────────────┐
│ ← 返回       需求库 (24)      [⚙️]       │
├─────────────────────────────────────────┤
│ 🔍 搜索...                              │
├─────────────────────────────────────────┤
│ 筛选: [全部▾] [标签▾] [⭐收藏] [📁归档] │
├─────────────────────────────────────────┤
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │ ⏳ 8 个内容待分析                   │ │
│ │ [批量分析] [全选] [清除]            │ │  ← 入口
│ └─────────────────────────────────────┘ │
│                                         │
│ ─────────────────────────────────────── │
│ 📄 待分析内容                           │
│ ┌─────────────────────────────────────┐ │
│ │ ☐ r/SaaS - Why is there no...      │ │
│ │    快速保存于 2小时前                │ │
│ └─────────────────────────────────────┘ │
│ ┌─────────────────────────────────────┐ │
│ │ ☐ 知乎 - 为什么国内没有...          │ │
│ │    快速保存于 3小时前                │ │
│ └─────────────────────────────────────┘ │
│ ...                                     │
└─────────────────────────────────────────┘
```

**入口 2：选择后批量操作**

用户可以勾选多个待分析内容，然后点击「批量分析选中项」。

#### 3.3.2 任务队列机制

批量分析复用 `AnalysisTask` 模型，将多个任务加入队列：

```typescript
// 批量分析触发逻辑
async function batchAnalyze(extractionIds: string[]): Promise<void> {
  const extractions = await extractionRepo.getByIds(extractionIds);

  for (const extraction of extractions) {
    // 为每个待分析内容创建任务
    const taskId = useAnalysisStore.getState().createTask({
      url: extraction.url,
      title: extraction.title,
      platform: extraction.platform,
    });

    // 关联 extraction，避免重复提取
    useAnalysisStore.getState().updateTaskStatus(taskId, 'pending', {
      extractionId: extraction.id,
    });
  }

  // 启动任务处理
  taskQueue.process();
}
```

#### 3.3.3 并发控制

| 配置项 | 值 | 说明 |
|-------|---|------|
| 最大并发数 | 3 | 同时进行的 LLM 请求数 |
| 单任务超时 | 60s | 超时后标记失败，可重试 |
| 失败重试次数 | 1 | 自动重试一次 |
| 批量上限 | 20 | 单次批量分析最多 20 个 |

```typescript
// 任务队列处理器
class TaskQueue {
  private maxConcurrent = 3;
  private running = 0;

  async process(): Promise<void> {
    const pendingTasks = useAnalysisStore.getState()
      .tasks.filter(t => t.status === 'pending');

    for (const task of pendingTasks) {
      if (this.running >= this.maxConcurrent) {
        await this.waitForSlot();
      }

      this.running++;
      this.processTask(task).finally(() => {
        this.running--;
        this.process(); // 继续处理下一个
      });
    }
  }
}
```

#### 3.3.4 进度展示

任务指示器在批量分析时显示总体进度：

```
┌─────────────────────────────────────────┐
│ 🔄 批量分析中                    [展开] │
│ ████████░░░░░░░░ 8/15 完成              │
│ 预计剩余 2 分钟                         │
└─────────────────────────────────────────┘
```

展开后显示各任务状态：

```
┌─────────────────────────────────────────┐
│ 🔄 批量分析任务                  [收起] │
├─────────────────────────────────────────┤
│                                         │
│ 整体进度: 8/15 完成                      │
│ ████████░░░░░░░░                        │
│                                         │
│ ⏳ 进行中 (3)                            │
│   • r/SaaS - Why is there no...        │
│   • 知乎 - 为什么国内没有...            │
│   • r/Entrepreneur - Looking for...    │
│                                         │
│ ✅ 已完成 (8)                            │
│   • Twitter - @indie_dev... → 2 个方向  │
│   • r/startups - Best tools... → 1 个方向│
│   • ...                                │
│                                         │
│ ⏸️ 等待中 (4)                            │
│   • 知乎 - 有什么好用的...              │
│   • ...                                │
│                                         │
│ ─────────────────────────────────────── │
│ [暂停全部] [取消全部]                    │
└─────────────────────────────────────────┘
```

### 3.4 与任务独立化的协同

| 方面 | 单个分析 | 批量分析 |
|-----|---------|---------|
| 任务创建 | 点击「分析此页面」创建 1 个 | 点击「批量分析」创建 N 个 |
| 任务队列 | 共用同一个 `tasks[]` | 共用同一个 `tasks[]` |
| 并发控制 | 最多 3 个并发 | 最多 3 个并发 |
| 进度展示 | 任务指示器 | 任务指示器（批量模式） |
| 完成通知 | 单个 Toast | 汇总 Toast |

### 3.5 边界场景处理

| 场景 | 处理方式 |
|-----|---------|
| 批量分析中关闭浏览器 | 未完成任务丢失，已完成的保存在 Extraction |
| 部分任务失败 | 失败任务单独重试，不影响其他任务 |
| API 额度中途耗尽 | 剩余任务标记为「额度不足」，可稍后重试 |
| 用户取消全部 | 所有 pending 任务标记为 cancelled |
| 用户暂停 | 不再启动新任务，进行中的继续完成 |

### 3.6 验收标准

| 验收项 | 标准 | 测试方法 |
|-------|------|---------|
| 批量创建任务 | 点击后创建正确数量的任务 | 选择 5 个待分析，检查任务数 |
| 并发控制生效 | 同时运行不超过 3 个 | 创建 10 个任务，观察并发数 |
| 进度显示正确 | 进度数字与实际一致 | 观察进度条更新 |
| 部分失败处理 | 失败任务可单独重试 | 模拟 1 个失败，检查重试功能 |
| 取消功能生效 | 取消后 pending 任务不再执行 | 批量分析中点击取消 |
| 完成汇总通知 | 全部完成后显示汇总 | 等待批量分析完成 |

---

## 四、功能二：Twitter/X 适配

### 4.1 平台特性分析

| 特性 | Twitter/X 情况 | 对适配的影响 |
|-----|---------------|-------------|
| **内容结构** | 推文（最长 280/4000 字符）+ 回复树 | 单条内容短，需聚合上下文 |
| **DOM 稳定性** | 频繁变化，React 动态渲染 | 选择器需要多套方案 |
| **反爬措施** | 有，但对浏览器扩展相对宽松 | 需遵守 rate limit |
| **登录要求** | 部分内容需登录查看 | 仅支持公开内容 |
| **需求信号密度** | 高（独立开发者、创业者活跃） | 值得适配 |

### 4.2 适配范围

#### 支持（In Scope）

| 页面类型 | URL 模式 | 提取内容 |
|---------|---------|---------|
| **单条推文详情页** | `x.com/*/status/*` | 主推文 + 回复 |
| **用户主页推文** | `x.com/*` (非 status) | 当前可见的推文列表 |
| **搜索结果页** | `x.com/search?*` | 当前可见的搜索结果 |

#### 不支持（Out of Scope）

| 限制 | 原因 | 替代方案 |
|-----|------|---------|
| 私密账户内容 | 需要用户授权，合规风险 | 提示用户手动复制 |
| 登录后才可见的内容 | 无法获取用户登录态 | 提示「请确保内容可见」 |
| 无限滚动自动加载 | 不主动触发，避免滥用 | 提取当前已加载内容 |
| Twitter Spaces | 音频内容，无法文本化 | 不支持 |
| 视频/图片内容 | 仅提取文本 | 提取附带的文字描述 |

### 4.3 内容提取方案

#### 4.3.1 支持的页面类型

**类型 1：单条推文详情页**

```
URL: https://x.com/username/status/1234567890

提取结构：
┌─────────────────────────────────────────┐
│ 主推文                                   │
│ ┌─────────────────────────────────────┐ │
│ │ @indie_dev · 2h                     │ │
│ │ Why is there no simple tool to...   │ │
│ │ 💬 45  🔁 12  ❤️ 89                  │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ 回复                                     │
│ ┌─────────────────────────────────────┐ │
│ │ @user1 · 1h                         │ │
│ │ I've been looking for this too...   │ │
│ └─────────────────────────────────────┘ │
│ ┌─────────────────────────────────────┐ │
│ │ @user2 · 30m                        │ │
│ │ Try XYZ tool, but it's $50/mo...    │ │
│ └─────────────────────────────────────┘ │
└─────────────────────────────────────────┘

提取输出：
{
  mainTweet: {
    author: "@indie_dev",
    content: "Why is there no simple tool to...",
    metrics: { replies: 45, retweets: 12, likes: 89 }
  },
  replies: [
    { author: "@user1", content: "I've been looking for this too..." },
    { author: "@user2", content: "Try XYZ tool, but it's $50/mo..." }
  ]
}
```

**类型 2：用户主页 / 搜索结果**

```
URL: https://x.com/search?q=saas%20tool

提取结构：提取当前可见的推文列表（最多 20 条）

提取输出：
{
  tweets: [
    { author: "@user1", content: "...", metrics: {...} },
    { author: "@user2", content: "...", metrics: {...} },
    ...
  ]
}
```

#### 4.3.2 DOM 选择器设计

Twitter 的 DOM 结构频繁变化，采用**多重选择器 + 特征匹配**策略：

```typescript
// src/content/adapters/twitter.ts

const SELECTORS = {
  // 主选择器（当前有效）
  tweet: '[data-testid="tweet"]',
  tweetText: '[data-testid="tweetText"]',
  userHandle: '[data-testid="User-Name"] a[href^="/"]',

  // 备用选择器（历史版本）
  tweetAlt: 'article[role="article"]',
  tweetTextAlt: '[lang] span',

  // 特征匹配（最稳定）
  tweetByStructure: 'article:has([data-testid="tweetText"])',
};

class TwitterAdapter extends BaseAdapter {
  canHandle(url: string): boolean {
    return /^https?:\/\/(www\.)?(twitter|x)\.com/.test(url);
  }

  async extract(): Promise<ExtractionResult> {
    // 尝试多种选择器
    let tweets = document.querySelectorAll(SELECTORS.tweet);
    if (tweets.length === 0) {
      tweets = document.querySelectorAll(SELECTORS.tweetAlt);
    }
    if (tweets.length === 0) {
      tweets = document.querySelectorAll(SELECTORS.tweetByStructure);
    }

    // 提取内容
    return this.parseTweets(tweets);
  }
}
```

#### 4.3.3 回退策略

| 优先级 | 策略 | 适用场景 |
|-------|------|---------|
| 1 | 专用选择器提取 | DOM 结构符合预期 |
| 2 | 备用选择器提取 | Twitter 更新后主选择器失效 |
| 3 | 通用文本提取 | 选择器全部失效 |
| 4 | 提示手动复制 | 内容无法自动提取 |

### 4.4 适配器实现

```typescript
// src/content/adapters/twitter.ts

import { BaseAdapter, ExtractionResult, PageInfo } from './base';

export class TwitterAdapter extends BaseAdapter {
  platform = 'twitter' as const;

  canHandle(url: string): boolean {
    return /^https?:\/\/(www\.)?(twitter|x)\.com/.test(url);
  }

  getPageInfo(): PageInfo {
    const url = window.location.href;
    const isStatusPage = /\/status\/\d+/.test(url);

    return {
      url,
      title: document.title,
      platform: 'twitter',
      pageType: isStatusPage ? 'tweet_detail' : 'tweet_list',
      canAnalyze: this.hasContent(),
    };
  }

  async extract(): Promise<ExtractionResult> {
    const isStatusPage = /\/status\/\d+/.test(window.location.href);

    if (isStatusPage) {
      return this.extractTweetDetail();
    } else {
      return this.extractTweetList();
    }
  }

  private extractTweetDetail(): ExtractionResult {
    // 提取主推文
    const mainTweet = this.extractMainTweet();

    // 提取回复（最多 30 条）
    const replies = this.extractReplies(30);

    // 组装文本
    const text = this.formatTweetThread(mainTweet, replies);

    return {
      success: true,
      content: {
        text,
        metadata: {
          mainTweet,
          replyCount: replies.length,
        },
      },
    };
  }

  private extractTweetList(): ExtractionResult {
    // 提取可见推文（最多 20 条）
    const tweets = this.extractVisibleTweets(20);

    const text = tweets
      .map(t => `@${t.author}: ${t.content}`)
      .join('\n\n---\n\n');

    return {
      success: true,
      content: {
        text,
        metadata: {
          tweetCount: tweets.length,
        },
      },
    };
  }

  private hasContent(): boolean {
    return document.querySelectorAll('[data-testid="tweet"]').length > 0
      || document.querySelectorAll('article[role="article"]').length > 0;
  }
}
```

### 4.5 用户引导

#### 4.5.1 权限申请

Twitter 适配需要用户授权站点权限：

```
┌─────────────────────────────────────────┐
│ Demand Radar 需要访问此站点              │
├─────────────────────────────────────────┤
│                                         │
│ 🐦 x.com (Twitter)                      │
│                                         │
│ 为了从 Twitter 提取需求信号，            │
│ 需要您授权此站点的访问权限。              │
│                                         │
│ 我们承诺：                               │
│ • 仅在您点击分析时提取内容               │
│ • 不会发送推文到任何服务器（LLM 除外）   │
│ • 不会获取您的 Twitter 账户信息          │
│                                         │
│ [授权访问] [暂不授权]                    │
└─────────────────────────────────────────┘
```

#### 4.5.2 使用提示

首次在 Twitter 上使用时显示引导：

```
┌─────────────────────────────────────────┐
│ 💡 Twitter 分析提示                      │
├─────────────────────────────────────────┤
│                                         │
│ 最佳实践：                               │
│ • 打开单条推文详情页，获取更完整的上下文  │
│ • 手动展开「显示更多回复」后再分析       │
│ • 私密账户内容无法提取                   │
│                                         │
│ 推荐搜索关键词：                         │
│ • "why is there no"                    │
│ • "looking for a tool"                 │
│ • "anyone know a good"                 │
│                                         │
│ [知道了]                                │
└─────────────────────────────────────────┘
```

### 4.6 验收标准

| 验收项 | 标准 | 测试方法 |
|-------|------|---------|
| 平台识别 | 正确识别 twitter.com 和 x.com | 访问两种域名检查 |
| 推文详情页提取 | 提取主推文 + 回复 | 访问 /status/* 页面分析 |
| 推文列表提取 | 提取可见推文 | 访问搜索结果页分析 |
| 选择器回退 | 主选择器失效时使用备用 | 手动禁用主选择器测试 |
| 内容格式化 | 输出格式符合 LLM 分析要求 | 检查输出结构 |
| 权限引导 | 未授权时正确提示 | 新安装后访问 Twitter |
| 限制说明 | 私密内容正确提示 | 访问私密账户页面 |

---

## 五、功能三：需求去重分析

### 5.1 功能定位

需求去重分析是「规模化发现」的核心功能：
- 当用户积累了足够多的需求后，帮助发现**反复出现的产品方向**
- 多次出现的方向 = 更强的市场信号
- LLM 辅助识别相似需求，**用户确认**后合并分组

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         需求去重价值链                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   单个需求                    识别模式                    验证信号       │
│                                                                         │
│   ┌─────────┐              ┌─────────┐              ┌─────────┐        │
│   │ 需求 A  │              │         │              │         │        │
│   │ PDF工具 │──┐           │ PDF工具 │              │ PDF工具 │        │
│   └─────────┘  │    LLM    │ 需求组  │    用户      │  方向   │        │
│   ┌─────────┐  │───────▶  │ (5条)   │───确认───▶  │  验证   │        │
│   │ 需求 B  │──┤   分析    │         │              │         │        │
│   │ PDF合并 │  │           └─────────┘              └─────────┘        │
│   └─────────┘  │                                                       │
│   ┌─────────┐  │                                                       │
│   │ 需求 C  │──┘           「这个方向被提及 5 次，                       │
│   │ 本地PDF │                值得深入调研！」                            │
│   └─────────┘                                                          │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 5.2 用户场景

> **用户**：独立开发者小李
> **场景**：使用 Demand Radar 两周，积累了 50 个产品方向
> **行为**：打开需求库，点击「🔍 分析重复需求」
> **结果**：
> - LLM 分析整个需求库，返回 3 组相似需求
> - 「PDF 工具需求」(5 条) — 来自 r/SaaS, 知乎, Twitter
> - 「笔记工具需求」(3 条) — 来自 r/productivity
> - 「API 监控需求」(2 条) — 来自 r/webdev
> - 小李确认合并，需求库变得更清晰
> **价值**：发现 PDF 工具方向被多次提及，决定深入调研

### 5.3 触发机制

**触发方式**：用户主动点击（不自动触发）

**为什么不自动触发**：
- 每次保存时自动检测：浪费 API 资源，单条匹配不准确
- 定时自动分析：用户无感知，可能产生困惑
- 用户主动触发：明确意图，结果可控

**触发入口**：

```
┌─────────────────────────────────────────┐
│ ← 返回       需求库 (50)    [🔍去重] [⚙️] │  ← 入口按钮
├─────────────────────────────────────────┤
│ ...                                     │
└─────────────────────────────────────────┘
```

**触发条件**：
- 需求库至少有 5 个已分析的需求
- 距离上次去重分析超过 24 小时（避免频繁调用）
- 用户 LLM 配置有效

### 5.4 分析算法

#### 5.4.1 输入数据

仅发送必要字段给 LLM，减少 token 消耗：

```typescript
interface DemandForDedup {
  id: string;
  title: string;           // solution.title
  description: string;     // solution.description（截断至 200 字）
  targetUser: string;      // solution.targetUser
  differentiators: string[]; // solution.keyDifferentiators（前 3 个）
}
```

#### 5.4.2 LLM Prompt

```
你是一个产品需求分析专家。请分析以下产品方向列表，找出指向**同一产品机会**的相似方向。

【输入】
${demands.map(d => `
ID: ${d.id}
标题: ${d.title}
描述: ${d.description}
目标用户: ${d.targetUser}
差异点: ${d.differentiators.join(', ')}
`).join('\n---\n')}

【判断标准】
将以下情况视为「同一产品机会」：
1. 解决同一个核心问题（如「PDF 合并」和「PDF 批处理」都是 PDF 处理需求）
2. 目标用户群体相同或高度重叠
3. 核心差异点有 2 个以上相同

【输出要求】
以 JSON 格式输出：
{
  "groups": [
    {
      "suggestedName": "分组名称（如「PDF 处理工具需求」）",
      "demandIds": ["id1", "id2", "id3"],
      "reason": "为什么认为这些是同一方向（一句话）",
      "commonPainPoints": ["共同痛点1", "共同痛点2"]
    }
  ],
  "uniqueDemands": ["id4", "id5"]  // 没有找到相似项的需求 ID
}

【注意事项】
1. 只有确信是同一方向时才归为一组，不确定时保持独立
2. 每组至少 2 个需求
3. 一个需求只能属于一个分组
4. 分组名称应简洁明了，便于用户理解
```

#### 5.4.3 输出结构

```typescript
interface DuplicateAnalysisResult {
  groups: Array<{
    suggestedName: string;      // LLM 建议的分组名
    demandIds: string[];        // 属于这一组的需求 ID
    reason: string;             // 归组理由
    commonPainPoints: string[]; // 共同痛点
  }>;
  uniqueDemands: string[];      // 没有重复的需求 ID
  analyzedAt: Date;             // 分析时间
  totalAnalyzed: number;        // 分析的需求总数
}
```

### 5.5 交互流程

#### 5.5.1 分析过程

```
┌─────────────────────────────────────────┐
│ 🔍 分析重复需求                          │
├─────────────────────────────────────────┤
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │ ████████████░░░░░░░░ 正在分析...    │ │
│ │ 分析 50 个需求中的相似项            │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ 预计需要 10-20 秒                        │
│ [取消]                                  │
│                                         │
└─────────────────────────────────────────┘
```

#### 5.5.2 分析结果

```
┌─────────────────────────────────────────┐
│ 🔍 发现 3 组相似需求                     │
├─────────────────────────────────────────┤
│                                         │
│ 分析了 50 个需求，发现以下相似组：        │
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │ 📁 PDF 处理工具需求              (5) │ │
│ │                                     │ │
│ │ • 本地 PDF 批量处理工具             │ │
│ │ • 简单的 PDF 合并工具               │ │
│ │ • 离线 PDF 编辑器                   │ │
│ │ • PDF 压缩工具                      │ │
│ │ • 隐私优先的 PDF 处理               │ │
│ │                                     │ │
│ │ 共同痛点：价格贵、隐私担忧、功能臃肿  │ │
│ │                                     │ │
│ │ [✓ 合并为一组] [✗ 保持独立]         │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │ 📁 笔记工具需求                  (3) │ │
│ │                                     │ │
│ │ • 本地优先的笔记应用                │ │
│ │ • Markdown 笔记工具                 │ │
│ │ • 离线知识库                        │ │
│ │                                     │ │
│ │ 共同痛点：同步慢、隐私问题           │ │
│ │                                     │ │
│ │ [✓ 合并为一组] [✗ 保持独立]         │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ ┌─────────────────────────────────────┐ │
│ │ 📁 API 监控需求                  (2) │ │
│ │ ...                                 │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ 独立需求：42 个（无相似项）               │
│                                         │
│ ─────────────────────────────────────── │
│ [全部合并] [全部保持独立] [完成]          │
└─────────────────────────────────────────┘
```

#### 5.5.3 用户确认

用户可以：
- **合并为一组**：将这些需求标记为同一分组
- **保持独立**：忽略此建议，需求保持独立
- **部分合并**：展开后取消勾选某些需求，只合并部分

### 5.6 合并后展示

合并后，需求库列表显示分组卡片：

```
┌─────────────────────────────────────────┐
│ ← 返回       需求库 (50)          [⚙️]   │
├─────────────────────────────────────────┤
│ 🔍 搜索...                              │
├─────────────────────────────────────────┤
│                                         │
│ 📁 需求分组 (3)                          │
│ ┌─────────────────────────────────────┐ │
│ │ ⭐ PDF 处理工具需求              [5] │ │
│ │                                     │ │
│ │ 本地运行 · 隐私优先 · 一次买断       │ │
│ │ 来源：r/SaaS, 知乎, Twitter          │ │
│ │                                     │ │
│ │ [展开查看] [深入分析]               │ │
│ └─────────────────────────────────────┘ │
│ ┌─────────────────────────────────────┐ │
│ │   笔记工具需求                   [3] │ │
│ │ ...                                 │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ ─────────────────────────────────────── │
│ 📄 独立需求 (42)                         │
│ ...                                     │
└─────────────────────────────────────────┘
```

**分组详情页**：

```
┌─────────────────────────────────────────┐
│ ← 返回       PDF 处理工具需求     [⭐][⋮] │
├─────────────────────────────────────────┤
│                                         │
│ 📊 分组统计                              │
│ ┌─────────────────────────────────────┐ │
│ │ 包含 5 个相似需求                   │ │
│ │ 来源：r/SaaS(2), 知乎(2), Twitter(1) │ │
│ │ 首次发现：3天前                     │ │
│ │ 最近更新：2小时前                   │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ 🎯 共同特征                              │
│ • 目标用户：需要处理 PDF 的办公人员     │
│ • 核心痛点：价格贵、隐私担忧、功能臃肿  │
│ • 差异化方向：本地运行、一次买断        │
│                                         │
│ ─────────────────────────────────────── │
│ 📄 包含的需求 (5)                        │
│ ┌─────────────────────────────────────┐ │
│ │ 本地 PDF 批量处理工具               │ │
│ │ r/SaaS · 3天前                      │ │
│ └─────────────────────────────────────┘ │
│ ┌─────────────────────────────────────┐ │
│ │ 简单的 PDF 合并工具                 │ │
│ │ 知乎 · 2天前                        │ │
│ └─────────────────────────────────────┘ │
│ ...                                     │
│                                         │
│ ─────────────────────────────────────── │
│ [🔗 在 ChatGPT 深入分析]                 │
│ [📤 导出分组]                            │
└─────────────────────────────────────────┘
```

### 5.7 数据模型扩展

```typescript
// 扩展 Demand 模型
interface Demand {
  // ... 现有字段 ...

  // === 分组信息（去重后填充）===
  groupId?: string;              // 所属分组 ID
  groupName?: string;            // 分组名称（冗余，便于显示）
  addedToGroupAt?: Date;         // 加入分组时间
}

// 新增：需求分组模型
interface DemandGroup {
  id: string;                    // UUID
  name: string;                  // 分组名称
  demandIds: string[];           // 包含的需求 ID

  // 统计信息
  demandCount: number;           // 需求数量
  platforms: string[];           // 来源平台列表
  firstSeenAt: Date;             // 最早需求时间
  lastSeenAt: Date;              // 最新需求时间

  // LLM 分析结果
  commonPainPoints: string[];    // 共同痛点
  suggestedDifferentiators: string[]; // 建议差异点

  // 用户操作
  starred: boolean;              // 是否收藏
  notes?: string;                // 用户笔记

  // 时间戳
  createdAt: Date;
  updatedAt: Date;
}
```

### 5.8 验收标准

| 验收项 | 标准 | 测试方法 |
|-------|------|---------|
| 触发条件 | 少于 5 个需求时禁用按钮 | 检查按钮状态 |
| 分析准确性 | 相似需求识别准确率 ≥ 80% | 人工评估 20 组样本 |
| 分组建议合理 | 分组名称和理由清晰 | 用户可理解性测试 |
| 用户确认生效 | 确认后正确更新数据 | 检查 groupId 字段 |
| 分组展示正确 | 分组卡片显示正确信息 | UI 验收 |
| 撤销功能 | 可解散分组恢复独立 | 点击解散后检查 |
| 重复分析 | 24h 内禁止重复分析 | 连续点击测试 |

---

## 六、技术架构变更

### 6.1 状态管理层变更

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         状态管理变更                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   v2.0 结构                              v2.1 结构                      │
│   ────────────                           ────────────                   │
│                                                                         │
│   ┌─────────────────┐                   ┌─────────────────┐            │
│   │ useAnalysisStore│                   │ useAnalysisStore│            │
│   ├─────────────────┤                   ├─────────────────┤            │
│   │ pageInfo        │                   │ currentPage     │ ← 仅页面   │
│   │ status          │ ──重构──▶         │ tasks[]         │ ← 任务队列 │
│   │ demands[]       │                   │ activeTaskId    │            │
│   │ ...             │                   │ indicatorExpanded│           │
│   └─────────────────┘                   └─────────────────┘            │
│                                                                         │
│                                         ┌─────────────────┐            │
│                                         │ useDemandsStore │ ← 新增分组 │
│                                         ├─────────────────┤            │
│                                         │ groups[]        │            │
│                                         │ lastDedupAt     │            │
│                                         └─────────────────┘            │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 6.2 消息通信变更

新增消息类型：

```typescript
// src/shared/types/messages.ts

export enum MessageType {
  // ... 现有消息类型 ...

  // === v2.1 新增 ===

  // 任务管理
  TASK_CREATED = 'TASK_CREATED',
  TASK_STATUS_UPDATED = 'TASK_STATUS_UPDATED',
  TASK_COMPLETED = 'TASK_COMPLETED',
  TASK_ERROR = 'TASK_ERROR',
  TASK_CANCELLED = 'TASK_CANCELLED',

  // 批量分析
  BATCH_ANALYZE_START = 'BATCH_ANALYZE_START',
  BATCH_ANALYZE_PROGRESS = 'BATCH_ANALYZE_PROGRESS',
  BATCH_ANALYZE_COMPLETE = 'BATCH_ANALYZE_COMPLETE',

  // 需求去重
  DEDUP_ANALYZE_START = 'DEDUP_ANALYZE_START',
  DEDUP_ANALYZE_COMPLETE = 'DEDUP_ANALYZE_COMPLETE',
  DEDUP_CONFIRM = 'DEDUP_CONFIRM',
}
```

### 6.3 数据模型变更汇总

| 模型 | 变更类型 | 说明 |
|-----|---------|------|
| `AnalysisTask` | **新增** | 分析任务模型，存储在 Zustand |
| `DemandGroup` | **新增** | 需求分组模型，持久化到 IndexedDB |
| `Demand` | **扩展** | 新增 `groupId`, `groupName`, `addedToGroupAt` 字段 |
| `Extraction` | **不变** | 保持原有结构 |

### 6.4 新增组件清单

| 组件 | 路径 | 说明 |
|-----|------|------|
| `TaskIndicator` | `src/sidepanel/components/TaskIndicator.tsx` | 任务指示器（收起/展开） |
| `TaskList` | `src/sidepanel/components/TaskList.tsx` | 任务列表 |
| `TaskItem` | `src/sidepanel/components/TaskItem.tsx` | 单个任务卡片 |
| `BatchAnalyzePanel` | `src/sidepanel/components/BatchAnalyzePanel.tsx` | 批量分析面板 |
| `DedupResultView` | `src/sidepanel/components/DedupResultView.tsx` | 去重结果展示 |
| `DemandGroupCard` | `src/sidepanel/components/DemandGroupCard.tsx` | 需求分组卡片 |
| `TwitterAdapter` | `src/content/adapters/twitter.ts` | Twitter 平台适配器 |

### 6.5 改动影响评估

| 模块 | 改动程度 | 风险评估 | 测试重点 |
|-----|---------|---------|---------|
| `analysis.ts` (store) | **大改** | 中 | 状态流转、页面切换 |
| `demands.ts` (store) | **中改** | 低 | 分组 CRUD |
| `message-handler.ts` | **中改** | 中 | 新消息类型处理 |
| `AnalysisView.tsx` | **中改** | 低 | UI 适配 |
| `DemandsView.tsx` | **中改** | 低 | 分组展示 |
| 新增组件 | **新增** | 低 | 组件功能 |
| `twitter.ts` (adapter) | **新增** | 中 | 平台兼容性 |

---

## 七、迭代计划

### 7.1 开发阶段划分

```
Week 1: 分析任务独立化
├── Day 1-2: 重构 analysis store
│     ├── 新增 AnalysisTask 模型
│     ├── 重构 setCurrentPage 逻辑
│     └── 实现任务队列基础
│
├── Day 3-4: 任务指示器 UI
│     ├── TaskIndicator 组件
│     ├── TaskList 组件
│     └── Toast 通知
│
└── Day 5: 集成测试
      └── 页面切换场景测试

Week 2: 批量分析 + Twitter 适配
├── Day 1-2: 批量分析
│     ├── 批量分析入口
│     ├── 并发控制
│     └── 进度展示
│
├── Day 3-4: Twitter 适配器
│     ├── TwitterAdapter 实现
│     ├── 选择器设计
│     └── 回退策略
│
└── Day 5: 测试 + 修复

Week 3: 需求去重 + 打磨
├── Day 1-2: 去重分析
│     ├── Prompt 设计
│     ├── 结果展示 UI
│     └── 用户确认流程
│
├── Day 3: 分组管理
│     ├── DemandGroup 模型
│     ├── 分组 CRUD
│     └── 分组详情页
│
├── Day 4-5: 测试 + 打磨
│     ├── 端到端测试
│     ├── 性能优化
│     └── UI 细节
```

### 7.2 里程碑定义

| 里程碑 | 完成标准 | 预计完成 |
|-------|---------|---------|
| M1: 任务独立化 | 页面切换不丢失分析，指示器正常工作 | Week 1 |
| M2: 批量分析 | 可批量分析待处理内容，进度正确显示 | Week 2 Day 2 |
| M3: Twitter 适配 | Twitter 页面可正常提取和分析 | Week 2 |
| M4: 需求去重 | 可分析重复需求并合并分组 | Week 3 Day 3 |
| M5: 迭代完成 | 全部功能测试通过，可发布 | Week 3 |

### 7.3 依赖关系

```
┌─────────────────┐
│ 分析任务独立化   │ ← 基础，其他功能依赖
└────────┬────────┘
         │
    ┌────┴────┐
    ▼         ▼
┌─────────┐  ┌─────────────┐
│ 批量分析 │  │ Twitter适配 │ ← 并行开发
└─────────┘  └─────────────┘
    │              │
    └──────┬───────┘
           ▼
    ┌─────────────┐
    │ 需求去重分析 │ ← 依赖有足够数据
    └─────────────┘
```

### 7.4 风险与应对

| 风险 | 影响 | 概率 | 应对措施 |
|-----|-----|-----|---------|
| Twitter DOM 频繁变化 | 适配器失效 | 高 | 多重选择器 + 回退策略 |
| 去重分析 Token 消耗大 | API 成本增加 | 中 | 仅发送必要字段，限制分析频率 |
| 任务队列内存占用 | 性能问题 | 低 | 限制队列大小（20 个） |
| 批量分析 API 限流 | 任务失败 | 中 | 并发控制 + 自动重试 |

---

## 八、验收标准汇总

### 8.1 功能验收清单

| 功能 | 验收项 | 通过标准 |
|-----|-------|---------|
| **任务独立化** | 页面切换不丢失 | 100% 任务完成 |
| | 任务指示器正确 | 数量和状态一致 |
| | 完成通知及时 | < 1s 延迟 |
| | 自动关联生效 | 返回页面显示结果 |
| **批量分析** | 批量创建任务 | 数量正确 |
| | 并发控制 | 最多 3 个同时 |
| | 进度显示 | 实时更新 |
| | 部分失败处理 | 可单独重试 |
| **Twitter 适配** | 平台识别 | twitter.com + x.com |
| | 推文提取 | 详情页 + 列表页 |
| | 选择器回退 | 有效率 ≥ 90% |
| **需求去重** | 触发条件 | ≥ 5 个需求 |
| | 分析准确性 | ≥ 80% |
| | 用户确认 | 正确更新数据 |
| | 分组展示 | UI 正确 |

### 8.2 性能指标

| 指标 | 目标值 | 测试方法 |
|-----|-------|---------|
| 任务指示器更新延迟 | < 100ms | 性能监控 |
| 批量分析 10 个任务 | < 3 分钟 | 计时测试 |
| 去重分析 50 个需求 | < 30s | 计时测试 |
| Twitter 提取时间 | < 2s | 计时测试 |
| 内存占用增加 | < 20MB | 内存监控 |

### 8.3 用户体验指标

| 指标 | 目标值 | 衡量方式 |
|-----|-------|---------|
| 任务完成感知 | 100% 用户知道任务完成 | 用户测试 |
| 去重结果理解度 | ≥ 90% 用户理解分组理由 | 用户测试 |
| 批量操作满意度 | ≥ 4/5 | 用户反馈 |

### 8.4 质量红线

| 红线 | 说明 |
|-----|------|
| 数据丢失 | 任何情况下不得丢失用户已保存的需求 |
| 隐私泄露 | 不得将用户数据发送到非 LLM 的第三方 |
| API 浪费 | 不得无意义重复调用 LLM |
| 崩溃率 | < 0.1% |

---

## 九、附录

### A. 新增 Prompt 模板

#### A.1 需求去重 Prompt

见 5.4.2 节。

#### A.2 分组合并摘要 Prompt（可选）

```
你是一个产品分析专家。请为以下同一方向的多个需求生成一个综合摘要。

【输入】
${demands.map(d => `
标题: ${d.title}
描述: ${d.description}
目标用户: ${d.targetUser}
差异点: ${d.differentiators.join(', ')}
痛点: ${d.painPoints.join(', ')}
`).join('\n---\n')}

【输出要求】
{
  "groupSummary": "综合描述（100字以内）",
  "consolidatedPainPoints": ["整合后的痛点1", "痛点2"],
  "consolidatedDifferentiators": ["整合后的差异点1", "差异点2"],
  "suggestedNextSteps": ["建议的下一步1", "下一步2"]
}
```

### B. 测试用例清单

#### B.1 分析任务独立化

| 用例 ID | 场景 | 预期结果 |
|--------|------|---------|
| T1-01 | 分析中切换页面 | 任务继续完成，Toast 通知 |
| T1-02 | 分析中刷新页面 | 任务继续完成 |
| T1-03 | 返回原页面 | 自动显示已完成结果 |
| T1-04 | 同一页面重复分析 | 提示确认 |
| T1-05 | 任务队列满 | 自动清理最早完成的 |
| T1-06 | 取消进行中任务 | 任务立即停止 |

#### B.2 批量分析

| 用例 ID | 场景 | 预期结果 |
|--------|------|---------|
| T2-01 | 批量分析 5 个 | 创建 5 个任务 |
| T2-02 | 并发控制 | 最多 3 个同时运行 |
| T2-03 | 部分失败 | 失败任务可重试 |
| T2-04 | 取消全部 | 所有 pending 任务取消 |

#### B.3 Twitter 适配

| 用例 ID | 场景 | 预期结果 |
|--------|------|---------|
| T3-01 | 推文详情页 | 提取主推文 + 回复 |
| T3-02 | 搜索结果页 | 提取可见推文 |
| T3-03 | 主选择器失效 | 使用备用选择器 |
| T3-04 | 私密账户 | 提示不支持 |

#### B.4 需求去重

| 用例 ID | 场景 | 预期结果 |
|--------|------|---------|
| T4-01 | 少于 5 个需求 | 按钮禁用 |
| T4-02 | 正常分析 | 返回分组建议 |
| T4-03 | 用户确认合并 | 更新 groupId |
| T4-04 | 用户拒绝合并 | 保持独立 |
| T4-05 | 24h 内重复分析 | 提示频率限制 |

### C. 变更记录

| 版本 | 日期 | 变更内容 | 作者 |
|-----|-----|---------|-----|
| 2.1-draft | 2025-12-10 | 初稿创建 | - |

---

**文档结束**

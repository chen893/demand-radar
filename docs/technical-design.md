# Demand Radar 技术设计文档

> 版本: 1.0
> 更新日期: 2025-12-10
> 基于 PRD 版本: 2.0
> 文档状态: 初稿

---

## 一、概述

### 1.1 文档目的

本文档旨在为 Demand Radar 浏览器插件提供清晰的技术实现方案，阐述系统架构、核心模块设计、关键技术决策及其背后的考量。文档面向开发团队，作为实现参考和技术沟通的基础。

### 1.2 产品简介

Demand Radar 是一款 Chrome 浏览器插件，帮助用户从 Reddit、知乎等平台的用户讨论中**提炼可执行的产品解决方案**。核心价值在于：

- **无缝嵌入工作流**：通过 Side Panel 融入日常浏览
- **解决方案导向**：输出产品方向而非简单的痛点评分
- **本地优先**：数据存储在用户本地，保护隐私
- **LLM 提炼 + 人工判断**：AI 负责提炼，用户负责决策

### 1.3 技术目标

| 目标 | 描述 | 量化指标 |
|-----|------|---------|
| **响应速度** | 用户操作应得到即时反馈 | 分析完成 < 10s（普通页面） |
| **稳定性** | 适配主流平台，提供降级方案 | 提取成功率 ≥ 90% |
| **可扩展性** | 易于添加新平台、新 LLM 服务商 | 新平台适配 < 2 天 |
| **隐私安全** | 最小化数据采集，保护用户隐私 | PII 脱敏率 100% |
| **资源占用** | 轻量运行，不影响浏览体验 | 常驻内存 < 80MB |

### 1.4 术语定义

| 术语 | 定义 |
|-----|------|
| **Extraction** | 一次页面内容提取的记录，包含原文、摘要、来源信息 |
| **Demand** | 从内容中提炼出的产品方向，是核心业务实体 |
| **Platform Adapter** | 针对特定平台（Reddit/知乎）的内容提取适配器 |
| **Side Panel** | Chrome 扩展的侧边栏界面，主要交互入口 |
| **Content Script** | 注入到网页中执行的脚本，负责内容提取 |
| **Service Worker** | MV3 扩展的后台服务，负责协调各组件 |

---

## 二、系统架构

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           Demand Radar 系统架构                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────┐    ┌─────────────────────────────────────────────────┐│
│  │   用户界面   │    │              Chrome Extension Runtime           ││
│  │             │    │  ┌─────────────────────────────────────────────┐││
│  │ ┌─────────┐ │    │  │           Service Worker (后台)             │││
│  │ │  Side   │ │◄──►│  │  ┌───────────┐  ┌───────────┐  ┌─────────┐ │││
│  │ │  Panel  │ │    │  │  │ 消息路由   │  │ LLM 服务  │  │存储管理 │ │││
│  │ └─────────┘ │    │  │  │ Dispatcher │  │  Layer    │  │ Storage │ │││
│  │             │    │  │  └───────────┘  └───────────┘  └─────────┘ │││
│  │ ┌─────────┐ │    │  └─────────────────────────────────────────────┘││
│  │ │ Settings│ │    │                       ▲                         ││
│  │ │  Page   │ │    │                       │ chrome.runtime          ││
│  │ └─────────┘ │    │                       ▼                         ││
│  └─────────────┘    │  ┌─────────────────────────────────────────────┐││
│                     │  │           Content Scripts (页面注入)         │││
│                     │  │  ┌───────────┐  ┌───────────┐  ┌─────────┐ │││
│                     │  │  │ Platform  │  │ Readability│ │  PII    │ │││
│                     │  │  │ Adapters  │  │ Extractor │  │ Filter  │ │││
│                     │  │  └───────────┘  └───────────┘  └─────────┘ │││
│                     │  └─────────────────────────────────────────────┘││
│                     └─────────────────────────────────────────────────┘│
│                                       │                                 │
│                                       ▼                                 │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                        外部依赖                                    │ │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                │ │
│  │  │  IndexedDB  │  │  LLM APIs   │  │  Web Pages  │                │ │
│  │  │  (Dexie.js) │  │ (LangChain) │  │ (Reddit等)  │                │ │
│  │  └─────────────┘  └─────────────┘  └─────────────┘                │ │
│  └───────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2.2 Chrome Extension 架构（MV3）

Chrome Extension Manifest V3 定义了扩展的基本架构约束：

```
┌─────────────────────────────────────────────────────────────┐
│                    Chrome Extension MV3                      │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │              Service Worker (background.ts)            │ │
│  │  • 事件驱动，无持久化状态                               │ │
│  │  • 处理扩展事件和消息路由                               │ │
│  │  • 协调 Content Script 和 UI 组件                       │ │
│  │  • 执行 LLM API 调用（避免 CORS 问题）                  │ │
│  └────────────────────────────────────────────────────────┘ │
│         ▲                                      ▲            │
│         │ chrome.runtime.sendMessage           │            │
│         ▼                                      ▼            │
│  ┌─────────────────┐                ┌─────────────────────┐ │
│  │  Content Script │                │   Side Panel / UI   │ │
│  │  (content.ts)   │                │   (React App)       │ │
│  │                 │                │                     │ │
│  │  • 页面DOM访问   │                │  • 用户交互界面      │ │
│  │  • 内容提取      │                │  • 状态管理(Zustand) │ │
│  │  • 隔离执行环境  │                │  • 结果展示          │ │
│  └─────────────────┘                └─────────────────────┘ │
│         │                                      │            │
│         ▼                                      ▼            │
│  ┌─────────────────┐                ┌─────────────────────┐ │
│  │   Web Page DOM  │                │    IndexedDB        │ │
│  │   (只读访问)     │                │    (持久存储)        │ │
│  └─────────────────┘                └─────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

**架构决策说明**：

| 组件 | 职责 | 设计考量 |
|-----|------|---------|
| **Service Worker** | 后台协调、LLM 调用 | MV3 要求，事件驱动模型，无持久状态 |
| **Content Script** | 页面内容提取 | 隔离环境访问 DOM，平台适配器在此运行 |
| **Side Panel** | 主要用户界面 | Chrome 114+ 原生支持，无需弹窗 |
| **IndexedDB** | 本地数据持久化 | 容量大、支持结构化数据、异步操作 |

### 2.3 模块划分

```
src/
├── background/                 # Service Worker
│   ├── index.ts               # 入口，事件监听
│   ├── message-handler.ts     # 消息路由处理
│   └── llm/                   # LLM 服务层
│       ├── index.ts           # 统一导出
│       ├── provider-factory.ts # 服务商工厂
│       ├── prompt-templates.ts # Prompt 模板
│       └── providers/         # 具体服务商实现
│           ├── openai.ts
│           ├── google.ts
│           └── deepseek.ts
│
├── content/                    # Content Scripts
│   ├── index.ts               # 入口，平台检测
│   ├── extractor.ts           # 通用提取逻辑
│   └── adapters/              # 平台适配器
│       ├── index.ts           # 适配器注册
│       ├── base.ts            # 基类定义
│       ├── reddit.ts          # Reddit 适配器
│       ├── zhihu.ts           # 知乎适配器
│       └── generic.ts         # 通用适配器
│
├── sidepanel/                  # Side Panel UI
│   ├── index.tsx              # React 入口
│   ├── App.tsx                # 根组件
│   ├── components/            # UI 组件
│   │   ├── AnalysisView.tsx   # 分析视图
│   │   ├── DemandCard.tsx     # 需求卡片
│   │   ├── DemandDetail.tsx   # 需求详情
│   │   └── DemandList.tsx     # 需求列表
│   └── stores/                # Zustand stores
│       ├── analysis.ts        # 分析状态
│       └── demands.ts         # 需求数据
│
├── storage/                    # 数据存储层
│   ├── db.ts                  # Dexie 数据库定义
│   ├── extraction-repo.ts     # Extraction 仓储
│   ├── demand-repo.ts         # Demand 仓储
│   └── config-repo.ts         # 配置仓储
│
├── shared/                     # 共享模块
│   ├── types/                 # TypeScript 类型定义
│   ├── constants.ts           # 常量定义
│   ├── utils/                 # 工具函数
│   │   ├── pii-filter.ts      # PII 脱敏
│   │   └── text-utils.ts      # 文本处理
│   └── messages.ts            # 消息类型定义
│
└── options/                    # 设置页面
    ├── index.tsx
    └── components/
        └── LLMConfig.tsx
```

### 2.4 数据流设计

**核心分析流程**：

```
用户点击「分析此页面」
        │
        ▼
┌───────────────────┐
│   Side Panel      │ 1. 发送分析请求
│   (React UI)      │────────────────────────┐
└───────────────────┘                        │
                                             ▼
                                   ┌───────────────────┐
                                   │  Service Worker   │
                                   │  (消息路由)        │
                                   └─────────┬─────────┘
                                             │ 2. 请求内容提取
                                             ▼
                                   ┌───────────────────┐
                                   │  Content Script   │
                                   │  (平台适配器)      │
                                   │                   │
                                   │  • 检测平台类型    │
                                   │  • 执行DOM提取     │
                                   │  • 返回结构化内容  │
                                   └─────────┬─────────┘
                                             │ 3. 返回提取内容
                                             ▼
                                   ┌───────────────────┐
                                   │  Service Worker   │
                                   │                   │
                                   │  • PII 脱敏        │
                                   │  • 调用 LLM API   │
                                   │  • 解析响应        │
                                   └─────────┬─────────┘
                                             │ 4. 流式返回结果
                                             ▼
┌───────────────────┐              ┌───────────────────┐
│   Side Panel      │◄─────────────│  LLM Service      │
│   (结果展示)       │   5. 更新UI  │  (LangChain.js)   │
└───────────────────┘              └───────────────────┘
        │
        │ 6. 用户保存
        ▼
┌───────────────────┐
│   IndexedDB       │
│   (Dexie.js)      │
└───────────────────┘
```

**消息通信协议**：

| 消息类型 | 方向 | 用途 |
|---------|------|------|
| `EXTRACT_CONTENT` | SW → Content | 请求提取页面内容 |
| `CONTENT_EXTRACTED` | Content → SW | 返回提取结果 |
| `ANALYZE_CONTENT` | Panel → SW | 请求 LLM 分析 |
| `ANALYSIS_CHUNK` | SW → Panel | 流式返回分析结果 |
| `ANALYSIS_COMPLETE` | SW → Panel | 分析完成通知 |
| `SAVE_DEMAND` | Panel → SW | 保存需求到数据库 |

---

## 三、核心模块设计

### 3.1 内容提取层

#### 3.1.1 平台适配器架构

采用**策略模式**实现平台适配，便于扩展新平台：

```
┌─────────────────────────────────────────────────────────────┐
│                   Platform Adapter 架构                      │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │              IPlatformAdapter (接口)                    │ │
│  │  • canHandle(url): boolean                             │ │
│  │  • extract(): Promise<ExtractionResult>                │ │
│  │  • getPlatformName(): string                           │ │
│  └────────────────────────────────────────────────────────┘ │
│                           ▲                                  │
│           ┌───────────────┼───────────────┐                 │
│           │               │               │                 │
│  ┌────────┴────┐  ┌───────┴─────┐  ┌──────┴──────┐        │
│  │RedditAdapter│  │ZhihuAdapter │  │GenericAdapter│        │
│  │             │  │             │  │              │        │
│  │ • 帖子提取   │  │ • 问答提取  │  │ • Readability│        │
│  │ • 评论树     │  │ • 回答内容  │  │ • 纯文本回退 │        │
│  │ • 投票数据   │  │ • 评论区    │  │              │        │
│  └─────────────┘  └─────────────┘  └──────────────┘        │
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │              AdapterRegistry (注册中心)                  │ │
│  │  • register(adapter): void                              │ │
│  │  • getAdapter(url): IPlatformAdapter                   │ │
│  │  • 优先级：专用适配器 > 通用适配器                        │ │
│  └────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

#### 3.1.2 提取策略与降级机制

```
内容提取流程
     │
     ▼
┌─────────────────┐
│ 检测当前URL     │
│ 匹配平台适配器   │
└────────┬────────┘
         │
    ┌────┴────┐
    │ 匹配成功？│
    └────┬────┘
    Yes  │  No
    ┌────┴────────────────┐
    ▼                     ▼
┌─────────────┐    ┌─────────────┐
│ 专用适配器   │    │ 通用适配器   │
│ (Reddit/    │    │ (Generic)   │
│  知乎)      │    │             │
└──────┬──────┘    └──────┬──────┘
       │                  │
       ▼                  ▼
┌─────────────┐    ┌─────────────┐
│ 结构化提取   │    │ Readability │
│ • 标题      │    │ 正文提取    │
│ • 正文      │    └──────┬──────┘
│ • 评论树    │           │
│ • 元数据    │      失败？│
└──────┬──────┘           ▼
       │           ┌─────────────┐
  失败？│           │ 纯文本回退   │
       ▼           │ innerText   │
┌─────────────┐    └──────┬──────┘
│ 降级到通用   │           │
│ 适配器      │───────────┤
└─────────────┘           │
                          ▼
                   ┌─────────────┐
                   │ 返回提取结果 │
                   │ + 截断处理  │
                   └─────────────┘
```

**提取结果数据结构**：

```typescript
interface ExtractionResult {
  success: boolean;
  platform: 'reddit' | 'zhihu' | 'generic';

  content: {
    title: string;
    body: string;           // 主要内容
    comments?: string[];    // 评论（如有）
    metadata: {
      author?: string;
      timestamp?: string;
      url: string;
    };
  };

  // 截断信息
  truncated: boolean;
  originalLength?: number;

  // 错误信息（降级时）
  fallbackUsed?: boolean;
  error?: string;
}
```

### 3.2 智能分析层（LLM 服务）

#### 3.2.1 LangChain.js 集成架构

采用 **LangChain.js** 作为 LLM 调用的统一抽象层，实现多服务商支持：

```
┌─────────────────────────────────────────────────────────────────┐
│                    LLM 服务层架构                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │                   LLMService (门面)                         │ │
│  │  • analyze(content): AsyncIterable<AnalysisChunk>          │ │
│  │  • testConnection(): Promise<boolean>                      │ │
│  │  • getCurrentProvider(): string                            │ │
│  └──────────────────────────┬─────────────────────────────────┘ │
│                             │                                    │
│                             ▼                                    │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │               ProviderFactory (工厂)                        │ │
│  │  • createProvider(config): BaseChatModel                   │ │
│  │  • 根据配置创建对应的 LangChain Chat Model                  │ │
│  └──────────────────────────┬─────────────────────────────────┘ │
│                             │                                    │
│         ┌───────────────────┼───────────────────┐               │
│         ▼                   ▼                   ▼               │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐        │
│  │ ChatOpenAI  │    │ChatGoogle   │    │ ChatOpenAI  │        │
│  │             │    │GenerativeAI │    │ (DeepSeek)  │        │
│  │@langchain/  │    │@langchain/  │    │ 自定义      │        │
│  │  openai     │    │ google-genai│    │ baseURL     │        │
│  └─────────────┘    └─────────────┘    └─────────────┘        │
│         │                   │                   │               │
│         └───────────────────┴───────────────────┘               │
│                             │                                    │
│                             ▼                                    │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │                  LLM Provider APIs                          │ │
│  │        OpenAI API  /  Google AI  /  DeepSeek API           │ │
│  └────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

**LangChain.js 依赖配置**：

```json
{
  "dependencies": {
    "@langchain/core": "^0.3.x",
    "@langchain/openai": "^0.3.x",
    "@langchain/google-genai": "^0.1.x"
  }
}
```

**服务商配置映射**：

| 服务商 | LangChain 类 | 配置方式 |
|-------|-------------|---------|
| OpenAI | `ChatOpenAI` | 直接使用 |
| Google | `ChatGoogleGenerativeAI` | 直接使用 |
| DeepSeek | `ChatOpenAI` | 自定义 `baseURL` |
| 自定义 | `ChatOpenAI` | 用户提供 `baseURL` |

#### 3.2.2 Provider 工厂实现思路

```typescript
// 服务商工厂核心逻辑
class ProviderFactory {
  createProvider(config: LLMConfig): BaseChatModel {
    switch (config.provider) {
      case 'openai':
        // 使用 @langchain/openai
        return new ChatOpenAI({
          model: config.modelName || 'gpt-4o-mini',
          apiKey: config.apiKey,
          streaming: true,
        });

      case 'google':
        // 使用 @langchain/google-genai
        return new ChatGoogleGenerativeAI({
          model: config.modelName || 'gemini-1.5-flash',
          apiKey: config.apiKey,
        });

      case 'deepseek':
        // DeepSeek 兼容 OpenAI API，使用自定义 baseURL
        return new ChatOpenAI({
          model: config.modelName || 'deepseek-chat',
          apiKey: config.apiKey,
          configuration: {
            baseURL: 'https://api.deepseek.com/v1',
          },
          streaming: true,
        });

      case 'custom':
        // 用户自定义 OpenAI 兼容服务
        return new ChatOpenAI({
          model: config.modelName,
          apiKey: config.apiKey,
          configuration: {
            baseURL: config.baseUrl,
          },
          streaming: true,
        });
    }
  }
}
```

#### 3.2.3 流式输出处理

LangChain.js 原生支持流式输出，提升用户体验：

```
LLM 流式响应处理
      │
      ▼
┌─────────────────────────────────────┐
│  model.stream(messages)             │
│  返回 AsyncIterable<AIMessageChunk> │
└──────────────────┬──────────────────┘
                   │
      ┌────────────┴────────────┐
      ▼                         ▼
┌─────────────┐          ┌─────────────┐
│ 摘要阶段    │          │ 方向阶段    │
│ 先输出摘要  │          │ 逐个输出    │
│ 快速反馈    │          │ 产品方向    │
└─────────────┘          └─────────────┘
      │                         │
      └────────────┬────────────┘
                   ▼
┌─────────────────────────────────────┐
│  通过 chrome.runtime 推送到 Panel   │
│  Panel 实时更新 UI                  │
└─────────────────────────────────────┘
```

#### 3.2.4 Prompt 工程

**解决方案提炼 Prompt 设计原则**：

1. **明确角色定位**：产品机会分析专家
2. **结构化输出**：强制 JSON 格式，便于解析
3. **证据导向**：要求提供原文支撑
4. **数量控制**：最多 3 个方向，避免发散

**Prompt 模板结构**：

```
┌─────────────────────────────────────────────────────────────┐
│                    Prompt 结构                              │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  [系统角色]                                                  │
│  你是一个产品机会分析专家，擅长从用户讨论中提炼产品方向...    │
│                                                              │
│  [输入内容]                                                  │
│  {经过 PII 脱敏的页面内容}                                   │
│                                                              │
│  [输出格式]                                                  │
│  严格 JSON 格式：                                            │
│  {                                                           │
│    "summary": "页面内容摘要",                                │
│    "demands": [{                                             │
│      "solution": { title, description, targetUser, ... },   │
│      "validation": { painPoints, competitors, quotes, ... } │
│    }]                                                        │
│  }                                                           │
│                                                              │
│  [约束条件]                                                  │
│  • quotes 必须来自原文                                       │
│  • 最多输出 3 个方向                                         │
│  • 无明显机会时返回空数组                                    │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

#### 3.2.5 错误处理与降级策略

```
LLM 调用错误处理流程
         │
         ▼
┌─────────────────┐
│  发起 LLM 请求  │
└────────┬────────┘
         │
    ┌────┴────┐
    │  成功？  │
    └────┬────┘
    Yes  │  No
    ─────┴──────────────────┐
                            ▼
                   ┌─────────────────┐
                   │   错误类型判断   │
                   └────────┬────────┘
         ┌─────────────┬────┴────┬─────────────┐
         ▼             ▼         ▼             ▼
    ┌─────────┐  ┌─────────┐ ┌─────────┐ ┌─────────┐
    │ 401     │  │ 429     │ │ 网络    │ │ 超时    │
    │API Key  │  │ 额度    │ │ 错误    │ │ >15s   │
    │ 无效    │  │ 耗尽    │ │         │ │        │
    └────┬────┘  └────┬────┘ └────┬────┘ └────┬────┘
         │            │           │           │
         ▼            ▼           ▼           ▼
    ┌─────────┐  ┌─────────┐ ┌─────────┐ ┌─────────┐
    │引导到   │  │存储原文 │ │重试1次  │ │后台继续 │
    │设置页   │  │提示检查 │ │仍失败→  │ │60s超时  │
    │         │  │账户额度 │ │离线模式 │ │→存储   │
    └─────────┘  └─────────┘ └─────────┘ └─────────┘
                            │
                            ▼
                   ┌─────────────────┐
                   │  降级：快速保存  │
                   │  Readability摘要 │
                   │  标记「待分析」  │
                   └─────────────────┘
```

**错误分类与处理策略**：

| 错误类型 | 重试 | 处理方式 | 用户提示 |
|---------|------|---------|---------|
| 401 认证失败 | 否 | 引导配置 | 「API Key 无效」 |
| 429 限流 | 是(延迟) | 存储原文 | 「额度耗尽」 |
| 网络错误 | 是(1次) | 离线模式 | 「网络连接失败」 |
| 超时 | 否 | 后台继续 | 「后台处理中」 |
| 解析错误 | 是(1次) | 原始存储 | 「分析结果异常」 |

### 3.3 数据管理层

#### 3.3.1 存储架构

采用 **Dexie.js** 封装 IndexedDB，提供类型安全和更友好的 API：

```
┌─────────────────────────────────────────────────────────────┐
│                    数据存储架构                              │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │                   Repository Layer                      │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐      │ │
│  │  │ExtractionRepo│ │ DemandRepo │ │ ConfigRepo  │      │ │
│  │  │             │ │             │ │             │      │ │
│  │  │ • create    │ │ • create    │ │ • get       │      │ │
│  │  │ • getById   │ │ • update    │ │ • set       │      │ │
│  │  │ • getByUrl  │ │ • delete    │ │             │      │ │
│  │  │             │ │ • search    │ │             │      │ │
│  │  └─────────────┘ └─────────────┘ └─────────────┘      │ │
│  └──────────────────────────┬─────────────────────────────┘ │
│                             │                                │
│                             ▼                                │
│  ┌────────────────────────────────────────────────────────┐ │
│  │                   Dexie.js ORM                          │ │
│  │  • 类型安全的表定义                                     │ │
│  │  • 索引管理                                             │ │
│  │  • 事务支持                                             │ │
│  └──────────────────────────┬─────────────────────────────┘ │
│                             │                                │
│                             ▼                                │
│  ┌────────────────────────────────────────────────────────┐ │
│  │                   IndexedDB                             │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐      │ │
│  │  │ extractions │ │   demands   │ │   config    │      │ │
│  │  └─────────────┘ └─────────────┘ └─────────────┘      │ │
│  └────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

**数据库 Schema 定义**：

```typescript
// Dexie 数据库定义
class DemandRadarDB extends Dexie {
  extractions!: Table<Extraction>;
  demands!: Table<Demand>;
  config!: Table<ConfigItem>;

  constructor() {
    super('DemandRadarDB');

    this.version(1).stores({
      // 主键 + 索引
      extractions: 'id, url, platform, capturedAt, analysisStatus',
      demands: 'id, extractionId, *tags, starred, archived, groupId, createdAt, [starred+createdAt]',
      config: 'key'
    });
  }
}
```

#### 3.3.2 容量管理策略

```
存储容量监控流程
         │
         ▼
┌─────────────────────┐
│  计算当前存储用量    │
│  (估算所有记录大小)  │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│   用量 / 限制比例   │
└──────────┬──────────┘
           │
    ┌──────┴──────┬──────────────┐
    ▼             ▼              ▼
< 80%         80-100%        > 100MB
(40MB)        (40-50MB)      (硬限制)
    │             │              │
    ▼             ▼              ▼
┌─────────┐  ┌─────────┐   ┌─────────┐
│ 正常    │  │ 显示    │   │ 阻止    │
│ 使用    │  │ 警告    │   │ 新增    │
│         │  │ Banner  │   │ 强提示  │
└─────────┘  └─────────┘   └─────────┘
```

**单条记录截断规则**：

| 条件 | 处理 | 截断字段 |
|-----|------|---------|
| 单条 < 500KB | 完整存储 | - |
| 单条 > 500KB | 截断 | originalText → 20,000 字符 |
| 仍超限 | 继续截断 | summary → 500 字符 |

### 3.4 用户界面层

#### 3.4.1 Side Panel 设计

Side Panel 作为主要交互入口，采用 React + Zustand 构建：

```
┌─────────────────────────────────────────────────────────────┐
│                    Side Panel 架构                          │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │                    App (根组件)                         │ │
│  │  • 路由管理（分析视图 / 需求库 / 设置）                   │ │
│  │  • 全局状态提供                                         │ │
│  └──────────────────────────┬─────────────────────────────┘ │
│                             │                                │
│         ┌───────────────────┼───────────────────┐           │
│         ▼                   ▼                   ▼           │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐     │
│  │AnalysisView │    │ DemandList  │    │ SettingsView│     │
│  │             │    │             │    │             │     │
│  │ • 页面信息   │    │ • 需求列表  │    │ • LLM配置   │     │
│  │ • 分析按钮   │    │ • 搜索筛选  │    │ • 站点白名单│     │
│  │ • 结果展示   │    │ • 批量操作  │    │ • 数据管理  │     │
│  └─────────────┘    └─────────────┘    └─────────────┘     │
│         │                   │                               │
│         └───────────────────┴───────────────────┐           │
│                                                 ▼           │
│                                       ┌─────────────┐       │
│                                       │ Zustand     │       │
│                                       │ Stores      │       │
│                                       │             │       │
│                                       │ • analysis  │       │
│                                       │ • demands   │       │
│                                       │ • ui        │       │
│                                       └─────────────┘       │
└─────────────────────────────────────────────────────────────┘
```

#### 3.4.2 状态管理设计

采用 **Zustand** 进行状态管理，轻量且与 React 深度集成：

**状态切片划分**：

| Store | 职责 | 主要状态 |
|-------|------|---------|
| `analysisStore` | 当前分析状态 | loading, result, error |
| `demandsStore` | 需求数据管理 | demands, filters, selectedIds |
| `uiStore` | UI 状态 | currentView, notifications |
| `configStore` | 配置状态 | llmConfig, siteFilters |

---

## 四、关键技术决策

### 4.1 技术选型理由

| 技术 | 选型 | 理由 |
|-----|------|------|
| **扩展框架** | Plasmo | MV3 原生支持、热重载、TypeScript 友好 |
| **UI 框架** | React 18 | 生态成熟、组件化、Side Panel 支持好 |
| **样式方案** | Tailwind CSS | 原子化、体积小、无运行时 |
| **状态管理** | Zustand | 轻量（< 1KB）、无 boilerplate、持久化支持 |
| **本地存储** | Dexie.js | IndexedDB 封装、类型安全、API 友好 |
| **LLM 调用** | LangChain.js | 多服务商抽象、流式支持、错误处理 |
| **内容提取** | @mozilla/readability | 业界标准、稳定可靠 |
| **HTML 清理** | DOMPurify | XSS 防护、安全可靠 |

### 4.2 架构权衡分析

#### 4.2.1 LLM 调用位置：Service Worker vs Content Script

| 方案 | 优点 | 缺点 |
|-----|------|------|
| **Service Worker（采用）** | 无 CORS 问题、统一管理 | 需消息传递 |
| Content Script | 直接访问 DOM | CORS 限制、安全风险 |

**决策**：在 Service Worker 中调用 LLM API，避免 CORS 问题，并统一管理 API Key。

#### 4.2.2 数据存储：IndexedDB vs chrome.storage

| 方案 | 优点 | 缺点 |
|-----|------|------|
| **IndexedDB（采用）** | 容量大（GB级）、结构化查询 | API 复杂（Dexie 解决） |
| chrome.storage.local | API 简单、自动同步 | 容量限制（5MB）|

**决策**：使用 IndexedDB + Dexie.js，支持大容量本地存储和复杂查询。

#### 4.2.3 UI 组件：Side Panel vs Popup

| 方案 | 优点 | 缺点 |
|-----|------|------|
| **Side Panel（采用）** | 常驻、不遮挡、沉浸式 | Chrome 114+ |
| Popup | 兼容性好 | 点击外部关闭、空间小 |

**决策**：采用 Side Panel 作为主要界面，提供更好的用户体验。

---

## 五、安全与隐私设计

### 5.1 权限最小化

**manifest.json 权限声明**：

```json
{
  "permissions": [
    "activeTab",     // 仅当前标签页
    "storage",       // 本地存储
    "scripting",     // 动态注入
    "sidePanel"      // Side Panel
  ],
  "host_permissions": [
    "https://*.reddit.com/*",
    "https://*.zhihu.com/*"
  ],
  "optional_host_permissions": [
    "https://*/*",
    "http://*/*"
  ]
}
```

**权限使用原则**：

| 原则 | 实现 |
|-----|-----|
| 按需申请 | 通用网页需用户手动授权 |
| 最小权限 | 不申请 `tabs`、`history` 等 |
| 声明式注入 | 已知平台使用 manifest 声明 |
| 动态注入 | 新站点使用 `chrome.scripting.executeScript` |

### 5.2 PII 脱敏机制

**脱敏时机**：仅在发送给 LLM 之前执行，本地存储保留原文。

```
内容处理流程
     │
     ▼
┌─────────────┐
│ 页面内容提取 │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 本地存储    │ ← 保留原文（便于用户查证）
│ IndexedDB   │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ PII 脱敏    │ ← 仅此处执行脱敏
│ • 邮箱 → [EMAIL]
│ • 电话 → [PHONE]
│ • 身份证 → [ID]
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ 发送至 LLM  │
└─────────────┘
```

**脱敏规则**：

| 类型 | 正则模式 | 替换为 |
|-----|---------|-------|
| 邮箱 | `[\w.-]+@[\w.-]+\.\w+` | `[EMAIL]` |
| 中国手机 | `1[3-9]\d{9}` | `[PHONE]` |
| 身份证 | `\d{17}[\dXx]` | `[ID]` |
| 信用卡 | `\d{4}[\s-]?\d{4}[\s-]?\d{4}[\s-]?\d{4}` | `[CARD]` |

### 5.3 站点白名单策略

```
站点访问控制流程
       │
       ▼
┌─────────────────┐
│ 用户访问页面    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 检查站点白名单  │
└────────┬────────┘
         │
    ┌────┴────┐
    │ 在白名单？│
    └────┬────┘
    Yes  │  No
    ┌────┴────────────────┐
    ▼                     ▼
┌─────────┐         ┌─────────────┐
│ 自动注入 │         │ 检查黑名单   │
│ Content │         └──────┬──────┘
│ Script  │                │
└─────────┘           ┌────┴────┐
                      │ 在黑名单？│
                      └────┬────┘
                      Yes  │  No
                      ┌────┴────────┐
                      ▼             ▼
                ┌─────────┐   ┌─────────────┐
                │ 禁止访问 │   │ 请求用户授权│
                │ 不注入   │   │ 确认后注入  │
                └─────────┘   └─────────────┘
```

**默认配置**：

- **白名单**：`*.reddit.com`, `*.zhihu.com`
- **黑名单**：`*.bank.*`, `mail.*`, `*.gov.*`, `*/login*`, `*/account*`

---

## 六、性能设计

### 6.1 性能指标

| 场景 | 目标 | 测量方式 |
|-----|------|---------|
| Side Panel 首次打开 | < 500ms | Performance API |
| 内容提取（普通页面） | < 2s | 从点击到返回 |
| LLM 首个 token | < 3s | 流式响应开始 |
| 完整分析（< 3000字） | < 6s | 端到端 |
| 需求库搜索（1000条） | < 500ms | 输入到结果 |

### 6.2 优化策略

**前端优化**：

| 策略 | 实现 | 效果 |
|-----|------|------|
| 虚拟列表 | react-window | 万条数据流畅滚动 |
| 懒加载 | React.lazy | 减少首屏体积 |
| 防抖搜索 | 300ms debounce | 减少无效渲染 |
| 骨架屏 | Skeleton 组件 | 改善感知速度 |

**LLM 优化**：

| 策略 | 实现 | 效果 |
|-----|------|------|
| 流式输出 | LangChain stream | 即时反馈 |
| 内容截断 | 超长内容裁剪 | 减少 token 消耗 |
| 缓存 | 相同 URL 短期缓存 | 避免重复分析 |

**存储优化**：

| 策略 | 实现 | 效果 |
|-----|------|------|
| 索引优化 | 复合索引 | 加速查询 |
| 分页加载 | 每次 20 条 | 减少内存占用 |
| 懒加载详情 | 点击再加载 | 减少初始数据量 |

---

## 七、扩展性设计

### 7.1 平台扩展

新增平台只需实现 `IPlatformAdapter` 接口：

```
新增平台适配器流程
         │
         ▼
┌─────────────────────┐
│ 1. 实现接口方法     │
│    • canHandle()    │
│    • extract()      │
│    • getPlatformName()
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ 2. 注册到 Registry  │
│    adapters.push()  │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ 3. 更新 manifest    │
│    host_permissions │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ 4. 测试验证         │
│    30+ 页面测试     │
└─────────────────────┘
```

### 7.2 LLM 服务商扩展

新增 LLM 服务商的两种方式：

**方式一：OpenAI 兼容 API**

直接使用 `ChatOpenAI` + 自定义 `baseURL`，无需新增代码。

**方式二：专用集成**

```
新增 LLM Provider
         │
         ▼
┌─────────────────────┐
│ 1. 安装对应包       │
│    @langchain/xxx   │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ 2. 更新工厂方法     │
│    ProviderFactory  │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ 3. 更新配置 UI      │
│    设置页面选项     │
└─────────────────────┘
```

### 7.3 P1 云同步预留

虽然 MVP 阶段仅支持本地存储，但架构预留了云同步扩展点：

```
Repository 层抽象
         │
         ├── LocalRepository (MVP)
         │   └── IndexedDB 实现
         │
         └── CloudRepository (P1)
             └── Supabase 实现
             └── 本地缓存 + 云端同步
```

**同步策略预设**：

| 策略 | 描述 |
|-----|------|
| 本地优先 | 所有操作先写本地，后台异步同步 |
| 增量同步 | 只同步变更，非全量覆盖 |
| 冲突解决 | 以最后修改时间为准 |

---

## 八、风险与应对

| 风险 | 影响 | 概率 | 应对措施 |
|-----|-----|------|---------|
| **平台 DOM 变更** | 提取失败 | 高 | 适配器架构 + 回退策略 + 监控告警 |
| **LLM API 不稳定** | 分析失败 | 中 | 重试机制 + 离线降级 + 多服务商 |
| **知乎反爬** | 平台不可用 | 中 | Week 0 验证 + 降级为通用提取 |
| **存储容量超限** | 数据丢失 | 低 | 容量管理 + 导出提醒 + 自动清理 |
| **API Key 泄露** | 用户损失 | 低 | 安全存储 + 使用指引 |
| **Chrome 审核被拒** | 上线延期 | 中 | 研究政策 + 预留缓冲周 |

---

## 附录

### A. 消息类型定义

```typescript
// 消息类型枚举
enum MessageType {
  // 内容提取
  EXTRACT_CONTENT = 'EXTRACT_CONTENT',
  CONTENT_EXTRACTED = 'CONTENT_EXTRACTED',

  // LLM 分析
  ANALYZE_CONTENT = 'ANALYZE_CONTENT',
  ANALYSIS_CHUNK = 'ANALYSIS_CHUNK',
  ANALYSIS_COMPLETE = 'ANALYSIS_COMPLETE',
  ANALYSIS_ERROR = 'ANALYSIS_ERROR',

  // 数据操作
  SAVE_DEMAND = 'SAVE_DEMAND',
  DELETE_DEMAND = 'DELETE_DEMAND',

  // 配置
  GET_CONFIG = 'GET_CONFIG',
  UPDATE_CONFIG = 'UPDATE_CONFIG',
}
```

### B. 错误码定义

| 错误码 | 描述 | 处理方式 |
|-------|------|---------|
| E001 | API Key 未配置 | 引导配置 |
| E002 | API Key 无效 | 提示检查 |
| E003 | API 额度耗尽 | 存储原文 |
| E004 | 网络错误 | 重试/离线 |
| E005 | 内容提取失败 | 降级处理 |
| E006 | LLM 响应解析失败 | 原始存储 |
| E007 | 存储容量超限 | 提示清理 |

### C. 参考资料

- [Chrome Extension MV3 文档](https://developer.chrome.com/docs/extensions/mv3/)
- [LangChain.js 文档](https://js.langchain.com/)
- [Dexie.js 文档](https://dexie.org/)
- [Plasmo 框架文档](https://docs.plasmo.com/)

---

**文档结束**
